<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <title>å¿ƒç§‹å°ç”Ÿæ´»</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root{
      --bg:#0f0f12; --card:#17171d; --text:#f2f2f3; --muted:#a0a0a8;
      --line:#2a2a33; --accent:#8b7cff; --danger:#ff5c7a; --good:#2bd576;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif;
      background:linear-gradient(180deg,#0b0b0e, #101016 35%, #0b0b0e);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px 14px 86px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      position:sticky; top:0; z-index:10;
      padding:14px 10px; margin:0 -14px 14px;
      background:rgba(15,15,18,.85); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex; flex-direction:column; line-height:1.1}
    .brand b{font-size:18px}
    .brand span{font-size:12px;color:var(--muted)}
    .pill{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }
    .btn{
      appearance:none; border:1px solid var(--line); background:var(--card); color:var(--text);
      border-radius:999px; padding:10px 12px; font-size:13px; cursor:pointer;
      box-shadow:0 1px 0 rgba(255,255,255,.04) inset;
    }
    .btn.primary{border-color:rgba(139,124,255,.45); background:rgba(139,124,255,.12)}
    .btn.danger{border-color:rgba(255,92,122,.45); background:rgba(255,92,122,.10)}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    .card{
      background:rgba(23,23,29,.92);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .tabs{display:flex; gap:6px; padding:10px; border-bottom:1px solid var(--line); flex-wrap:wrap}
    .tab{
      border:1px solid var(--line); background:transparent; color:var(--text);
      padding:9px 12px; border-radius:999px; font-size:13px; cursor:pointer;
    }
    .tab.on{background:rgba(139,124,255,.18); border-color:rgba(139,124,255,.5)}
    .content{padding:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{flex:1 1 150px; min-width:130px}
    label{display:block; font-size:12px; color:var(--muted); margin:6px 2px}
    input, textarea, select{
      width:100%; padding:11px 12px; border-radius:12px;
      border:1px solid var(--line); background:#101015; color:var(--text);
      outline:none;
    }
    textarea{min-height:86px; resize:vertical}
    .hint{font-size:12px;color:var(--muted); margin-top:8px}
    .list{display:flex; flex-direction:column; gap:10px; margin-top:12px}
    .item{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:rgba(16,16,21,.7);
    }
    .meta{display:flex; gap:10px; flex-wrap:wrap; align-items:center; color:var(--muted); font-size:12px}
    .title{font-size:15px; margin:8px 0 6px}
    .stars{letter-spacing:2px; color:#ffd166}
    .actions{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
    .small{font-size:12px; padding:8px 10px}
    .sep{height:1px;background:var(--line); margin:10px 0}
    .footer{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      background:rgba(15,15,18,.9); backdrop-filter:blur(10px);
      border-top:1px solid var(--line);
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      display:flex; gap:10px; justify-content:space-between; align-items:center;
    }
    .footer .btn{flex:1}
    dialog{
      width:min(820px, calc(100vw - 22px));
      border:1px solid var(--line);
      border-radius:18px;
      background:#0f0f13;
      color:var(--text);
      box-shadow:var(--shadow);
    }
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .dlg-h{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .dlg-h b{font-size:15px}
    pre{
      white-space:pre-wrap; word-break:break-word;
      background:#0b0b10; border:1px solid var(--line);
      border-radius:14px; padding:12px; color:var(--text); font-size:12px;
      max-height:55vh; overflow:auto;
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="brand">
      <b>å¿ƒç§‹å°ç”Ÿæ´»</b>
      <span id="sub">æœ¬åœ°ä¿å­˜ Â· å¸¦ç¼–è¾‘å†å²</span>
    </div>
    <div class="pill">
      <button class="btn primary" id="btnExport">å¯¼å‡ºå¤‡ä»½</button>
      <button class="btn" id="btnImport">å¯¼å…¥å¤‡ä»½</button>
      <button class="btn danger" id="btnWipe">æ¸…ç©ºæ•°æ®</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="tabs" id="tabs"></div>
      <div class="content" id="panel"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="content">
        <b style="font-size:14px">æœ€è¿‘è®°å½•</b>
        <div class="hint">ç‚¹â€œå†å²â€å¯ä»¥çœ‹åˆ°æ¯æ¬¡ç¼–è¾‘çš„æ—¶é—´ä¸æ”¹åŠ¨å†…å®¹ã€‚</div>
        <div class="list" id="list"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <button class="btn primary" id="btnAdd">æ–°å¢</button>
    <button class="btn" id="btnToday">ä»Šå¤©</button>
  </div>

  <dialog id="dlgHistory">
    <div class="content">
      <div class="dlg-h">
        <b>ç¼–è¾‘å†å²</b>
        <button class="btn small" id="btnCloseHistory">å…³é—­</button>
      </div>
      <div class="sep"></div>
      <pre id="historyBox"></pre>
    </div>
  </dialog>

  <dialog id="dlgBackup">
    <div class="content">
      <div class="dlg-h">
        <b>å¤‡ä»½ / å¯¼å…¥</b>
        <button class="btn small" id="btnCloseBackup">å…³é—­</button>
      </div>
      <div class="sep"></div>
      <div class="row">
        <div class="field" style="flex:1 1 100%">
          <label>æŠŠè¿™é‡Œçš„ JSON å¤åˆ¶ä¿å­˜ï¼›æˆ–æŠŠä½ çš„ JSON ç²˜è¿›æ¥å¯¼å…¥</label>
          <textarea id="backupArea" placeholder="è¿™é‡Œä¼šæ˜¾ç¤ºå¯¼å‡ºçš„JSONâ€¦"></textarea>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnCopy">å¤åˆ¶</button>
        <button class="btn" id="btnDoImport">ä»æ–‡æœ¬å¯¼å…¥</button>
      </div>
      <div class="hint">å¯¼å…¥ä¼šè¦†ç›–å½“å‰æ•°æ®ï¼ˆå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ï¼‰ã€‚</div>
    </div>
  </dialog>

<script>
(() => {
  const KEY = "xq_life_v1";
  const cats = [
    { id:"snack", name:"é›¶é£Ÿè¯„åˆ†" },
    { id:"money", name:"è®°è´¦" },
    { id:"study", name:"å­¦ä¹ æ‰“å¡" },
    { id:"todo",  name:"ä»£åŠæ¸…å•" },
    { id:"life",  name:"ç”Ÿæ´»è®°å½•" },
  ];
  const $ = sel => document.querySelector(sel);

  const nowISO = () => new Date().toISOString();
  const fmt = (iso) => {
    try {
      const d = new Date(iso);
      const pad = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    } catch { return iso; }
  };

  const emptyState = () => ({
    version: 1,
    items: [] // {id, cat, data, createdAt, updatedAt, history:[{ts, what}]}
  });

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return emptyState();
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.items)) return emptyState();
      return obj;
    }catch(e){
      return emptyState();
    }
  }
  function save(){
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  let state = load();
  let currentCat = "snack";

  // UI: Tabs
  const tabs = $("#tabs");
  tabs.innerHTML = cats.map(c => `<button class="tab" data-cat="${c.id}">${c.name}</button>`).join("");
  function setTab(cat){
    currentCat = cat;
    [...tabs.querySelectorAll(".tab")].forEach(b => b.classList.toggle("on", b.dataset.cat===cat));
    renderPanel();
    renderList();
  }
  tabs.addEventListener("click", (e) => {
    const b = e.target.closest(".tab");
    if(!b) return;
    setTab(b.dataset.cat);
  });

  // Panel forms per category
  function renderPanel(){
    const panel = $("#panel");
    const cat = currentCat;

    if(cat==="snack"){
      panel.innerHTML = `
        <div class="row">
          <div class="field">
            <label>é›¶é£Ÿåç§°</label>
            <input id="f_name" placeholder="ä¾‹å¦‚ï¼šæµ·è‹”è‚‰æ¾å°è´" />
          </div>
          <div class="field">
            <label>åº—é“º/æ¥æº</label>
            <input id="f_shop" placeholder="ä¾‹å¦‚ï¼šé›¶é£Ÿæœ‰é¸£" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>å–œçˆ±ç¨‹åº¦ï¼ˆ1-5â­ï¼‰</label>
            <select id="f_star">
              <option value="1">1â­</option>
              <option value="2">2â­</option>
              <option value="3" selected>3â­</option>
              <option value="4">4â­</option>
              <option value="5">5â­</option>
            </select>
          </div>
          <div class="field">
            <label>å¤‡æ³¨</label>
            <input id="f_note" placeholder="å£æ„Ÿ/ç”œåº¦/å›è´­ï¼Ÿ" />
          </div>
        </div>
        <div class="hint">æ–°å¢åå¯ä»¥ç‚¹â€œç¼–è¾‘/å†å²â€ã€‚ï¼ˆæ¯æ¬¡æ”¹åŠ¨éƒ½ä¼šè®°å½•æ—¶é—´ï¼‰</div>
      `;
      return;
    }

    if(cat==="money"){
      panel.innerHTML = `
        <div class="row">
          <div class="field">
            <label>é‡‘é¢ï¼ˆå…ƒï¼‰</label>
            <input id="f_amount" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š18.5" />
          </div>
          <div class="field">
            <label>ç±»åˆ«</label>
            <input id="f_type" placeholder="å¥¶èŒ¶/çŒ«ç²®/é€šå‹¤/é¥­â€¦" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>æ˜¯å¦ä¸ºå¿…è¦å¼€æ”¯</label>
            <select id="f_need">
              <option value="need">å¿…è¦</option>
              <option value="want" selected>æƒ³è¦</option>
            </select>
          </div>
          <div class="field">
            <label>å¤‡æ³¨</label>
            <input id="f_note" placeholder="åº—å/åŸå› /ä¼˜æƒ åˆ¸" />
          </div>
        </div>
      `;
      return;
    }

    if(cat==="study"){
      panel.innerHTML = `
        <div class="row">
          <div class="field">
            <label>ç§‘ç›®</label>
            <input id="f_subject" placeholder="è¯­æ–‡/æ•°å­¦/è‹±è¯­/æ”¿æ²»/å†å²/åœ°ç†" />
          </div>
          <div class="field">
            <label>å­¦ä¹ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
            <input id="f_minutes" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š45" />
          </div>
        </div>
        <div class="row">
          <div class="field" style="flex:1 1 100%">
            <label>å­¦äº†ä»€ä¹ˆ</label>
            <textarea id="f_content" placeholder="ä»Šå¤©åˆ·äº†å“ªå¥—å·/å“ªå‡ ä¸ªçŸ¥è¯†ç‚¹â€¦"></textarea>
          </div>
        </div>
      `;
      return;
    }

    if(cat==="todo"){
      panel.innerHTML = `
        <div class="row">
          <div class="field" style="flex:1 1 100%">
            <label>ä»£åŠå†…å®¹</label>
            <input id="f_task" placeholder="ä¾‹å¦‚ï¼šç»™æ¢¨èŠ±é¢„çº¦ç–«è‹— / æ‰“å°è¯•å· / èƒŒè¯µâ€¦" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>ä¼˜å…ˆçº§</label>
            <select id="f_pri">
              <option value="low">ä½</option>
              <option value="mid" selected>ä¸­</option>
              <option value="high">é«˜</option>
            </select>
          </div>
          <div class="field">
            <label>çŠ¶æ€</label>
            <select id="f_done">
              <option value="todo" selected>æœªå®Œæˆ</option>
              <option value="done">å·²å®Œæˆ</option>
            </select>
          </div>
        </div>
      `;
      return;
    }

    // life
    panel.innerHTML = `
      <div class="row">
        <div class="field">
          <label>æ ‡é¢˜</label>
          <input id="f_title" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©å¿ƒæƒ…/å‘ç”Ÿçš„äº‹" />
        </div>
      </div>
      <div class="row">
        <div class="field" style="flex:1 1 100%">
          <label>å†…å®¹</label>
          <textarea id="f_body" placeholder="éšæ‰‹è®°ï¼šå¤©æ°”/å·¥ä½œ/æœ‹å‹/çµæ„Ÿâ€¦"></textarea>
        </div>
      </div>
    `;
  }

  // Add item
  function addItem(){
    const cat = currentCat;
    const createdAt = nowISO();
    let data = {};
    try{
      if(cat==="snack"){
        data = {
          name: ($("#f_name").value || "").trim(),
          shop: ($("#f_shop").value || "").trim(),
          star: Number($("#f_star").value || 3),
          note: ($("#f_note").value || "").trim()
        };
        if(!data.name) return toast("å…ˆå†™é›¶é£Ÿåç§°ï½");
      } else if(cat==="money"){
        const amount = ($("#f_amount").value || "").trim();
        data = {
          amount: amount ? Number(amount) : 0,
          type: ($("#f_type").value || "").trim(),
          need: $("#f_need").value,
          note: ($("#f_note").value || "").trim()
        };
        if(!data.amount) return toast("é‡‘é¢è¦å¡«ä¸€ä¸ªæ•°å­—ï½");
      } else if(cat==="study"){
        data = {
          subject: ($("#f_subject").value || "").trim(),
          minutes: Number(($("#f_minutes").value||"").trim() || 0),
          content: ($("#f_content").value || "").trim()
        };
        if(!data.subject && !data.content) return toast("è‡³å°‘å†™ä¸ªç§‘ç›®æˆ–å†…å®¹ï½");
      } else if(cat==="todo"){
        data = {
          task: ($("#f_task").value || "").trim(),
          pri: $("#f_pri").value,
          done: $("#f_done").value
        };
        if(!data.task) return toast("å…ˆå†™ä»£åŠå†…å®¹ï½");
      } else { // life
        data = {
          title: ($("#f_title").value || "").trim(),
          body: ($("#f_body").value || "").trim()
        };
        if(!data.title && !data.body) return toast("è‡³å°‘å†™ç‚¹æ ‡é¢˜æˆ–å†…å®¹ï½");
      }
    } catch(e){
      return toast("è¾“å…¥æ¡†è¯»å–å¤±è´¥ï¼Œåˆ·æ–°è¯•è¯•ï½");
    }

    const item = {
      id: uid(),
      cat,
      data,
      createdAt,
      updatedAt: createdAt,
      history: [{ ts: createdAt, what: "åˆ›å»º" }]
    };

    state.items.unshift(item);
    save();
    clearInputs();
    renderList();
    toast("å·²æ–°å¢ âœ…");
  }

  function clearInputs(){
    ["#f_name","#f_shop","#f_note","#f_amount","#f_type","#f_subject","#f_minutes","#f_content","#f_task","#f_title","#f_body"].forEach(s=>{
      const el = document.querySelector(s);
      if(el) el.value = "";
    });
    const star = $("#f_star"); if(star) star.value = "3";
    const need = $("#f_need"); if(need) need.value = "want";
    const pri = $("#f_pri"); if(pri) pri.value = "mid";
    const done = $("#f_done"); if(done) done.value = "todo";
  }

  // Render list
  function renderList(){
    const list = $("#list");
    const items = state.items.filter(x => x.cat === currentCat);
    if(items.length===0){
      list.innerHTML = `<div class="item"><div class="meta">è¿™é‡Œè¿˜æ²¡æœ‰è®°å½•å“¦ï½</div><div class="hint">ç‚¹åº•éƒ¨â€œæ–°å¢â€å¼€å§‹ã€‚</div></div>`;
      return;
    }
    list.innerHTML = items.map(renderItem).join("");
  }

  function escapeHtml(s){
    return (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function renderItem(it){
    const cAt = fmt(it.createdAt);
    const uAt = fmt(it.updatedAt);
    let title = "", body = "", extra = "";

    if(it.cat==="snack"){
      title = `${escapeHtml(it.data.name)} <span class="stars">${"â­".repeat(Math.max(1,Math.min(5,it.data.star||3)))}</span>`;
      body = [it.data.shop ? `æ¥æºï¼š${escapeHtml(it.data.shop)}` : "",
              it.data.note ? `å¤‡æ³¨ï¼š${escapeHtml(it.data.note)}` : ""]
              .filter(Boolean).join("<br>");
    } else if(it.cat==="money"){
      title = `Â¥${Number(it.data.amount||0).toFixed(2)} Â· ${escapeHtml(it.data.type||"æœªåˆ†ç±»")}`;
      extra = it.data.need==="need" ? `<span style="color:var(--good)">å¿…è¦</span>` : `<span style="color:var(--muted)">æƒ³è¦</span>`;
      body = it.data.note ? `å¤‡æ³¨ï¼š${escapeHtml(it.data.note)}` : "";
    } else if(it.cat==="study"){
      title = `${escapeHtml(it.data.subject||"å­¦ä¹ ")} Â· ${Number(it.data.minutes||0)} åˆ†é’Ÿ`;
      body = escapeHtml(it.data.content||"");
    } else if(it.cat==="todo"){
      const done = it.data.done==="done";
      title = `${done ? "âœ…" : "ğŸ•’"} ${escapeHtml(it.data.task||"")}`;
      extra = `ä¼˜å…ˆçº§ï¼š${escapeHtml(it.data.pri||"mid")}`;
      body = "";
    } else {
      title = escapeHtml(it.data.title || "ï¼ˆæ— æ ‡é¢˜ï¼‰");
      body = escapeHtml(it.data.body || "");
    }

    return `
      <div class="item" data-id="${it.id}">
        <div class="meta">
          <span>åˆ›å»ºï¼š${cAt}</span>
          <span>æ›´æ–°ï¼š${uAt}</span>
          ${extra ? `<span>Â· ${extra}</span>` : ""}
        </div>
        <div class="title">${title}</div>
        ${body ? `<div class="hint">${body}</div>` : ""}
        <div class="actions">
          <button class="btn small" data-act="edit">ç¼–è¾‘</button>
          <button class="btn small" data-act="history">å†å²</button>
          <button class="btn small danger" data-act="del">åˆ é™¤</button>
        </div>
      </div>
    `;
  }

  // Edit / history / delete handlers
  $("#list").addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-act]");
    if(!btn) return;
    const itemEl = e.target.closest(".item[data-id]");
    const id = itemEl?.dataset?.id;
    const act = btn.dataset.act;
    if(!id) return;
    const it = state.items.find(x=>x.id===id);
    if(!it) return;

    if(act==="history"){
      openHistory(it);
      return;
    }
    if(act==="del"){
      if(!confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;
      state.items = state.items.filter(x=>x.id!==id);
      save(); renderList(); toast("å·²åˆ é™¤");
      return;
    }
    if(act==="edit"){
      quickEdit(it);
      return;
    }
  });

  function openHistory(it){
    const dlg = $("#dlgHistory");
    const box = $("#historyBox");
    const lines = (it.history||[]).map(h => `â€¢ ${fmt(h.ts)}  ${h.what}`).join("\n");
    box.textContent = lines || "ï¼ˆæ²¡æœ‰å†å²è®°å½•ï¼‰";
    dlg.showModal();
  }

  $("#btnCloseHistory").addEventListener("click", ()=>$("#dlgHistory").close());

  function quickEdit(it){
    // ç®€æ´ç¼–è¾‘ï¼šç”¨ promptï¼Œæ‰‹æœºæœ€ç¨³ï¼ˆä¸ç”¨å¤æ‚å¼¹çª—è¡¨å•ï¼‰
    const before = JSON.stringify(it.data);
    let changedWhat = [];

    if(it.cat==="snack"){
      const name = prompt("é›¶é£Ÿåç§°ï¼š", it.data.name||""); if(name===null) return;
      const shop = prompt("æ¥æº/åº—é“ºï¼š", it.data.shop||""); if(shop===null) return;
      const star = prompt("æ˜Ÿçº§ 1-5ï¼š", String(it.data.star||3)); if(star===null) return;
      const note = prompt("å¤‡æ³¨ï¼š", it.data.note||""); if(note===null) return;

      const newData = { name:name.trim(), shop:shop.trim(), star: clampStar(star), note:note.trim() };
      it.data = newData;

      changedWhat.push(diffText("åç§°", it.data.name, JSON.parse(before).name));
      changedWhat.push(diffText("æ¥æº", it.data.shop, JSON.parse(before).shop));
      changedWhat.push(diffText("æ˜Ÿçº§", String(it.data.star), String(JSON.parse(before).star)));
      changedWhat.push(diffText("å¤‡æ³¨", it.data.note, JSON.parse(before).note));
    }
    else if(it.cat==="money"){
      const amount = prompt("é‡‘é¢ï¼š", String(it.data.amount||0)); if(amount===null) return;
      const type = prompt("ç±»åˆ«ï¼š", it.data.type||""); if(type===null) return;
      const need = prompt("å¿…è¦/æƒ³è¦ï¼ˆneed/wantï¼‰ï¼š", it.data.need||"want"); if(need===null) return;
      const note = prompt("å¤‡æ³¨ï¼š", it.data.note||""); if(note===null) return;

      const old = JSON.parse(before);
      it.data = { amount: Number(amount)||0, type:type.trim(), need:(need==="need"?"need":"want"), note:note.trim() };
      changedWhat.push(diffText("é‡‘é¢", String(it.data.amount), String(old.amount)));
      changedWhat.push(diffText("ç±»åˆ«", it.data.type, old.type));
      changedWhat.push(diffText("å±æ€§", it.data.need, old.need));
      changedWhat.push(diffText("å¤‡æ³¨", it.data.note, old.note));
    }
    else if(it.cat==="study"){
      const subject = prompt("ç§‘ç›®ï¼š", it.data.subject||""); if(subject===null) return;
      const minutes = prompt("åˆ†é’Ÿï¼š", String(it.data.minutes||0)); if(minutes===null) return;
      const content = prompt("å­¦äº†ä»€ä¹ˆï¼š", it.data.content||""); if(content===null) return;

      const old = JSON.parse(before);
      it.data = { subject:subject.trim(), minutes:Number(minutes)||0, content:content.trim() };
      changedWhat.push(diffText("ç§‘ç›®", it.data.subject, old.subject));
      changedWhat.push(diffText("åˆ†é’Ÿ", String(it.data.minutes), String(old.minutes)));
      changedWhat.push(diffText("å†…å®¹", it.data.content, old.content));
    }
    else if(it.cat==="todo"){
      const task = prompt("ä»£åŠå†…å®¹ï¼š", it.data.task||""); if(task===null) return;
      const pri  = prompt("ä¼˜å…ˆçº§ low/mid/highï¼š", it.data.pri||"mid"); if(pri===null) return;
      const done = prompt("çŠ¶æ€ todo/doneï¼š", it.data.done||"todo"); if(done===null) return;

      const old = JSON.parse(before);
      it.data = { task:task.trim(), pri: sanitizePri(pri), done:(done==="done"?"done":"todo") };
      changedWhat.push(diffText("å†…å®¹", it.data.task, old.task));
      changedWhat.push(diffText("ä¼˜å…ˆçº§", it.data.pri, old.pri));
      changedWhat.push(diffText("çŠ¶æ€", it.data.done, old.done));
    }
    else {
      const title = prompt("æ ‡é¢˜ï¼š", it.data.title||""); if(title===null) return;
      const body  = prompt("å†…å®¹ï¼š", it.data.body||""); if(body===null) return;

      const old = JSON.parse(before);
      it.data = { title:title.trim(), body:body.trim() };
      changedWhat.push(diffText("æ ‡é¢˜", it.data.title, old.title));
      changedWhat.push(diffText("å†…å®¹", it.data.body, old.body));
    }

    // è¿‡æ»¤æœªå˜åŒ–
    changedWhat = changedWhat.filter(Boolean);
    const ts = nowISO();
    it.updatedAt = ts;
    it.history = it.history || [];
    it.history.unshift({ ts, what: changedWhat.length ? ("ç¼–è¾‘ï¼š" + changedWhat.join("ï¼›")) : "ç¼–è¾‘ï¼šæœªå˜åŒ–" });

    save();
    renderList();
    toast("å·²æ›´æ–° âœ…");
  }

  function diffText(label, nowV, oldV){
    if((nowV??"") === (oldV??"")) return "";
    return `${label}ï¼š${oldV??""} â†’ ${nowV??""}`.trim();
  }
  function clampStar(v){
    const n = Number(v);
    if(!n || n<1) return 1;
    if(n>5) return 5;
    return Math.round(n);
  }
  function sanitizePri(v){
    v = (v||"").toLowerCase().trim();
    if(v==="low"||v==="mid"||v==="high") return v;
    return "mid";
  }

  // Tiny toast
  let tmr = null;
  function toast(msg){
    clearTimeout(tmr);
    $("#sub").textContent = msg;
    tmr = setTimeout(()=>$("#sub").textContent="æœ¬åœ°ä¿å­˜ Â· å¸¦ç¼–è¾‘å†å²", 1800);
  }

  // Footer buttons
  $("#btnAdd").addEventListener("click", addItem);
  $("#btnToday").addEventListener("click", () => {
    toast("ä»Šå¤©ï¼š" + fmt(nowISO()));
  });

  // Backup / import / wipe
  const dlgB = $("#dlgBackup");
  $("#btnExport").addEventListener("click", () => {
    $("#backupArea").value = JSON.stringify(state, null, 2);
    dlgB.showModal();
  });
  $("#btnImport").addEventListener("click", () => {
    $("#backupArea").value = "";
    dlgB.showModal();
  });
  $("#btnCloseBackup").addEventListener("click", ()=>dlgB.close());
  $("#btnCopy").addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText($("#backupArea").value || "");
      toast("å·²å¤åˆ¶å¤‡ä»½");
    }catch{
      toast("å¤åˆ¶å¤±è´¥ï¼šé•¿æŒ‰å…¨é€‰å¤åˆ¶");
    }
  });
  $("#btnDoImport").addEventListener("click", () => {
    try{
      const txt = ($("#backupArea").value || "").trim();
      if(!txt) return toast("å…ˆç²˜è´´ JSONï½");
      const obj = JSON.parse(txt);
      if(!obj || !Array.isArray(obj.items)) return toast("JSON æ ¼å¼ä¸å¯¹");
      state = obj;
      save();
      renderList();
      dlgB.close();
      toast("å¯¼å…¥æˆåŠŸ âœ…");
    }catch(e){
      toast("å¯¼å…¥å¤±è´¥ï¼šæ£€æŸ¥ JSON æ˜¯å¦å®Œæ•´");
    }
  });
  $("#btnWipe").addEventListener("click", () => {
    if(!confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼ˆå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ï¼‰ã€‚")) return;
    state = emptyState();
    save();
    renderList();
    toast("å·²æ¸…ç©º");
  });

  // Service worker
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("sw.js").catch(()=>{});
  }

  // Init
  setTab("snack");
})();
</script>
</body>
</html>
