<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>å¿ƒç§‹å°ç”Ÿæ´»</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --shadow: 0 10px 40px rgba(0,0,0,.45);
      --r:18px;
      --r2:24px;
      --pad:16px;
      --a1:#8b5cf6;
      --a2:#22c55e;
      --a3:#06b6d4;
      --danger:#ef4444;
      --warn:#f59e0b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC","Hiragino Sans GB","Noto Sans CJK SC","Microsoft YaHei", Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(139,92,246,.35), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.20), transparent 60%),
        radial-gradient(800px 500px at 50% 110%, rgba(6,182,212,.18), transparent 60%),
        linear-gradient(180deg, #07080b, #0b0c10 35%, #0a0b0f);
      min-height:100vh;
      padding-bottom:90px;
    }
    a{ color:inherit; }
    .wrap{ max-width:980px; margin:0 auto; padding:18px 14px 40px; }
    .top{
      position:sticky; top:0; z-index:10;
      padding:10px 0 12px;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(11,12,16,.85), rgba(11,12,16,.40));
    }
    .titleRow{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding: 8px 2px 12px;
    }
    .brand{
      display:flex; flex-direction:column; gap:4px;
    }
    h1{
      margin:0;
      font-size:22px;
      letter-spacing:.5px;
    }
    .sub{ color:var(--muted); font-size:12px; }
    .pillRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .btn{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      color:var(--text);
      padding:10px 12px;
      border-radius: 999px;
      font-size:13px;
      cursor:pointer;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(139,92,246,.35);
      background: linear-gradient(180deg, rgba(139,92,246,.28), rgba(139,92,246,.10));
    }
    .btn.good{
      border-color: rgba(34,197,94,.35);
      background: linear-gradient(180deg, rgba(34,197,94,.22), rgba(34,197,94,.08));
    }
    .btn.danger{
      border-color: rgba(239,68,68,.35);
      background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.08));
    }
    .btn.ghost{
      background: transparent;
      box-shadow:none;
    }
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      padding: 8px 2px 10px;
    }
    .tab{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--muted);
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }
    .tab.active{
      color:var(--text);
      border-color: rgba(139,92,246,.45);
      background: linear-gradient(180deg, rgba(139,92,246,.22), rgba(255,255,255,.04));
    }
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      margin-top:10px;
    }
    @media (max-width:860px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid var(--line);
      border-radius: var(--r2);
      padding: var(--pad);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(500px 160px at 15% 0%, rgba(139,92,246,.20), transparent 60%),
        radial-gradient(420px 160px at 85% 0%, rgba(34,197,94,.14), transparent 60%);
      pointer-events:none;
      opacity:.85;
    }
    .card > *{ position:relative; }
    .card h2{
      margin:0 0 10px;
      font-size:16px;
      letter-spacing:.3px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .field{
      display:flex; flex-direction:column; gap:6px;
      margin:10px 0;
      width:100%;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
    }
    input, select, textarea{
      width:100%;
      background: rgba(10,11,15,.55);
      color: var(--text);
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{ min-height:86px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(139,92,246,.55);
      box-shadow: 0 0 0 3px rgba(139,92,246,.14);
    }
    .hint{ color:var(--muted2); font-size:12px; margin-top:8px; line-height:1.5; }
    .split{
      border-top:1px solid var(--line);
      margin:14px 0 10px;
      opacity:.75;
    }
    .list{
      display:flex; flex-direction:column; gap:10px;
      margin-top:10px;
    }
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 12px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      cursor:pointer;
    }
    .item:active{ transform: translateY(1px); }
    .itMain{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .itTitle{
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .itMeta{
      font-size:12px;
      color:var(--muted);
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .chip{
      font-size:11px;
      padding: 3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background: rgba(255,255,255,.04);
    }
    .chip.type{ border-color: rgba(6,182,212,.35); }
    .chip.group{ border-color: rgba(34,197,94,.35); }
    .chip.star{ border-color: rgba(245,158,11,.40); }
    .itRight{
      display:flex; flex-direction:column; gap:6px; align-items:flex-end;
      color:var(--muted);
      font-size:12px;
      flex:0 0 auto;
    }
    .fabBar{
      position: fixed; left:0; right:0; bottom:0;
      padding: 12px 14px calc(12px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(11,12,16,0), rgba(11,12,16,.85) 35%, rgba(11,12,16,.95));
      backdrop-filter: blur(14px);
      z-index: 20;
      display:flex; justify-content:center;
    }
    .fabInner{
      max-width:980px; width:100%;
      display:flex; gap:10px;
    }
    .grow{ flex:1; }
    .modalMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      z-index: 50;
    }
    .modal{
      width:min(980px, 100%);
      background: linear-gradient(180deg, rgba(20,21,28,.98), rgba(15,16,22,.98));
      border:1px solid rgba(255,255,255,.10);
      border-radius: 24px;
      box-shadow: 0 18px 60px rgba(0,0,0,.65);
      overflow:hidden;
      max-height: 86vh;
      display:flex; flex-direction:column;
    }
    .modalHeader{
      padding: 14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalHeader strong{ font-size:14px; letter-spacing:.2px; }
    .modalBody{
      padding: 14px 16px 16px;
      overflow:auto;
    }
    .tools{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .two{
      display:grid; grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:560px){ .two{ grid-template-columns:1fr; } }
    .empty{
      border:1px dashed rgba(255,255,255,.16);
      border-radius: 16px;
      padding: 14px;
      color: var(--muted);
      text-align:center;
      background: rgba(255,255,255,.03);
    }
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 92px;
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.16);
      padding:10px 12px;
      border-radius: 999px;
      color: var(--text);
      font-size: 12px;
      display:none;
      z-index: 70;
      backdrop-filter: blur(10px);
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New"; }
  </style>
</head>
<body>
  <div class="top">
    <div class="wrap">
      <div class="titleRow">
        <div class="brand">
          <h1>å¿ƒç§‹å°ç”Ÿæ´»</h1>
          <div class="sub">æœ¬åœ°ä¿å­˜ Â· å¯æœç´¢ Â· å¯ç¼–è¾‘ Â· å¯å¯¼å…¥å¯¼å‡º</div>
        </div>
        <div class="pillRow">
          <button class="btn ghost" id="btnAll">ğŸ“š å…¨éƒ¨è®°å½•</button>
          <button class="btn" id="btnGroups">ğŸ—‚ï¸ åˆ†ç»„</button>
          <button class="btn" id="btnBackup">â¬†ï¸ å¯¼å‡º</button>
          <button class="btn" id="btnRestore">â¬‡ï¸ å¯¼å…¥</button>
          <button class="btn danger" id="btnWipe">ğŸ§¨ æ¸…ç©º</button>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card" id="cardForm">
        <h2 id="formTitle">æ–°å¢</h2>
        <div id="formFields"></div>

        <div class="row">
          <button class="btn primary grow" id="btnAdd">â• æ–°å¢è®°å½•</button>
          <button class="btn" id="btnReset">â†©ï¸ é‡ç½®</button>
        </div>

        <div class="hint">
          å°æç¤ºï¼šæ–°å¢åä½ å¯ä»¥åœ¨å³è¾¹ã€Œæœ€è¿‘è®°å½•ã€ç‚¹è¿›å»æŸ¥çœ‹/ç¼–è¾‘/åˆ é™¤ï¼Œä¹Ÿå¯ä»¥å»ã€Œå…¨éƒ¨è®°å½•ã€æœç´¢ä½ å†™çš„å†…å®¹ã€‚
        </div>
      </div>

      <div class="card">
        <h2>æœ€è¿‘è®°å½•</h2>
        <div class="hint" id="recentHint">æ˜¾ç¤ºå½“å‰æ¨¡å—æœ€è¿‘ 5 æ¡</div>
        <div class="split"></div>
        <div class="list" id="recentList"></div>
        <div class="split"></div>
        <div class="row">
          <button class="btn good grow" id="btnQuickAll">ğŸ” å»å…¨éƒ¨è®°å½•æœç´¢</button>
        </div>
      </div>
    </div>
  </div>

  <div class="fabBar">
    <div class="fabInner">
      <button class="btn primary grow" id="btnAdd2">â• æ–°å¢</button>
      <button class="btn grow" id="btnAll2">ğŸ“š å…¨éƒ¨è®°å½•</button>
    </div>
  </div>

  <!-- å…¨éƒ¨è®°å½• -->
  <div class="modalMask" id="maskAll">
    <div class="modal">
      <div class="modalHeader">
        <strong>ğŸ“š å…¨éƒ¨è®°å½•</strong>
        <button class="btn" data-close="maskAll">âœ– å…³é—­</button>
      </div>
      <div class="modalBody">
        <div class="tools">
          <input id="q" placeholder="æœç´¢ï¼šæ ‡é¢˜ / å†…å®¹ / åº—é“º / å¤‡æ³¨ / é‡‘é¢..." />
          <select id="fType"></select>
          <select id="fGroup"></select>
        </div>
        <div class="hint" id="allStat"></div>
        <div class="split"></div>
        <div class="list" id="allList"></div>
      </div>
    </div>
  </div>

  <!-- è¯¦æƒ…/ç¼–è¾‘ -->
  <div class="modalMask" id="maskDetail">
    <div class="modal">
      <div class="modalHeader">
        <strong id="detailTitle">è¯¦æƒ…</strong>
        <button class="btn" data-close="maskDetail">âœ– å…³é—­</button>
      </div>
      <div class="modalBody">
        <div id="detailFields"></div>
        <div class="split"></div>
        <div class="row">
          <button class="btn primary grow" id="btnSaveEdit">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
          <button class="btn danger" id="btnDelete">ğŸ—‘ï¸ åˆ é™¤</button>
        </div>
        <div class="hint">åˆ é™¤åä¸å¯æ¢å¤ï¼ˆé™¤éä½ ä¹‹å‰å¯¼å‡ºè¿‡å¤‡ä»½ï¼‰ã€‚</div>
      </div>
    </div>
  </div>

  <!-- åˆ†ç»„ç®¡ç† -->
  <div class="modalMask" id="maskGroups">
    <div class="modal">
      <div class="modalHeader">
        <strong>ğŸ—‚ï¸ åˆ†ç»„ç®¡ç†</strong>
        <button class="btn" data-close="maskGroups">âœ– å…³é—­</button>
      </div>
      <div class="modalBody">
        <div class="two">
          <div class="field">
            <label>æ–°å¢åˆ†ç»„å</label>
            <input id="newGroupName" placeholder="ä¾‹å¦‚ï¼šåƒå– / å­¦ä¹  / ç”Ÿæ´» / å¤‡è€ƒ..." />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button class="btn good" id="btnAddGroup">â• æ·»åŠ åˆ†ç»„</button>
          </div>
        </div>
        <div class="split"></div>
        <div class="hint">å½“å‰åˆ†ç»„ï¼ˆç‚¹å‡»å¯åˆ é™¤ï¼›é»˜è®¤åˆ†ç»„ä¸å¯åˆ ï¼‰</div>
        <div class="list" id="groupList"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ========== é…ç½® ==========
    const TYPES = [
      { id:"snack", name:"é›¶é£Ÿè¯„åˆ†", icon:"ğŸª" },
      { id:"money", name:"è®°è´¦", icon:"ğŸ’°" },
      { id:"study", name:"å­¦ä¹ æ‰“å¡", icon:"ğŸ“š" },
      { id:"todo",  name:"ä»£åŠæ¸…å•", icon:"âœ…" },
      { id:"life",  name:"ç”Ÿæ´»è®°å½•", icon:"ğŸŒ™" },
    ];

    // æ¯ä¸ªç±»å‹çš„å­—æ®µå®šä¹‰ï¼ˆç”¨äºæ¸²æŸ“è¡¨å•&è¯¦æƒ…ï¼‰
    const SCHEMA = {
      snack: [
        { k:"title",  label:"é›¶é£Ÿåç§°", type:"text", ph:"ä¾‹å¦‚ï¼šæµ·è‹”è‚‰æ¾å°è´", req:true },
        { k:"source", label:"åº—é“º/æ¥æº", type:"text", ph:"ä¾‹å¦‚ï¼šé›¶é£Ÿæœ‰é¸£ / è¶…å¸‚ / å¤–å–", req:false },
        { k:"rating", label:"å–œçˆ±ç¨‹åº¦ï¼ˆ1-5â­ï¼‰", type:"select", options:["1â­","2â­","3â­","4â­","5â­"], req:true, def:"3â­" },
        { k:"note",   label:"å¤‡æ³¨", type:"textarea", ph:"å£æ„Ÿ/ç”œåº¦/å›è´­ï¼Ÿ", req:false },
      ],
      money: [
        { k:"title",  label:"æ”¯å‡º/æ”¶å…¥é¡¹ç›®", type:"text", ph:"ä¾‹å¦‚ï¼šçŒ«ç²® / å¥¶èŒ¶ / è½¦è´¹", req:true },
        { k:"amount", label:"é‡‘é¢ï¼ˆå…ƒï¼‰", type:"number", ph:"ä¾‹å¦‚ï¼š58", req:true },
        { k:"kind",   label:"ç±»å‹", type:"select", options:["æ”¯å‡º","æ”¶å…¥"], req:true, def:"æ”¯å‡º" },
        { k:"note",   label:"å¤‡æ³¨", type:"textarea", ph:"ç”¨äº†ä»€ä¹ˆåˆ¸ï¼Ÿä¸ºä»€ä¹ˆä¹°ï¼Ÿ", req:false },
      ],
      study: [
        { k:"title",  label:"å­¦ä¹ å†…å®¹", type:"text", ph:"ä¾‹å¦‚ï¼šè‹±è¯­é˜…è¯» / æ•°å­¦å‡½æ•° / å†å²é€‰æ‹©é¢˜", req:true },
        { k:"mins",   label:"å­¦ä¹ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰", type:"number", ph:"ä¾‹å¦‚ï¼š45", req:true },
        { k:"quality",label:"çŠ¶æ€ï¼ˆä¸»è§‚ï¼‰", type:"select", options:["æ‘¸é±¼","ä¸€èˆ¬","ä¸“æ³¨","çˆ†å‘"], req:true, def:"ä¸€èˆ¬" },
        { k:"note",   label:"æ€»ç»“/æ”¶è·", type:"textarea", ph:"ä»Šå¤©å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿå“ªé‡Œå¡ä½ï¼Ÿ", req:false },
      ],
      todo: [
        { k:"title",  label:"å¾…åŠæ ‡é¢˜", type:"text", ph:"ä¾‹å¦‚ï¼šå¸¦æ¢¨èŠ±æ‰“ç–«è‹— / æ‰“å°è¯•å·", req:true },
        { k:"due",    label:"æˆªæ­¢æ—¥æœŸï¼ˆå¯é€‰ï¼‰", type:"date", ph:"", req:false },
        { k:"status", label:"çŠ¶æ€", type:"select", options:["æœªå®Œæˆ","è¿›è¡Œä¸­","å·²å®Œæˆ"], req:true, def:"æœªå®Œæˆ" },
        { k:"note",   label:"å¤‡æ³¨", type:"textarea", ph:"æ‹†è§£æ­¥éª¤ / æ³¨æ„äº‹é¡¹", req:false },
      ],
      life: [
        { k:"title",  label:"æ ‡é¢˜", type:"text", ph:"ä¾‹å¦‚ï¼šä»Šå¤©çš„å¿ƒæƒ… / çœ‹åˆ°çš„å¤©ç©º", req:true },
        { k:"content",label:"å†…å®¹", type:"textarea", ph:"æƒ³å†™ä»€ä¹ˆéƒ½å¯ä»¥ï½", req:true },
      ]
    };

    const STORE_KEY = "xq_life_v2_store";
    const defaultData = {
      version: 2,
      groups: ["é»˜è®¤"],
      records: [] // {id,type,group,data,createdAt,updatedAt}
    };

    // ========== å·¥å…· ==========
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, cls) => { const n=document.createElement(tag); if(cls) n.className=cls; return n; };
    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
    const nowISO = () => new Date().toISOString();
    const fmtTime = (iso) => {
      const d = new Date(iso);
      const pad = (x)=> String(x).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };
    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> t.style.display="none", 1800);
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) return structuredClone(defaultData);
        const d = JSON.parse(raw);
        if(!d || typeof d !== "object") return structuredClone(defaultData);
        if(!Array.isArray(d.groups) || !Array.isArray(d.records)) return structuredClone(defaultData);
        if(!d.groups.includes("é»˜è®¤")) d.groups.unshift("é»˜è®¤");
        return d;
      }catch(e){
        return structuredClone(defaultData);
      }
    }
    function save(){
      localStorage.setItem(STORE_KEY, JSON.stringify(state));
    }

    function openMask(id){ $("#"+id).style.display="flex"; }
    function closeMask(id){ $("#"+id).style.display="none"; }

    // ========== çŠ¶æ€ ==========
    let state = load();
    let currentType = "snack";
    let editingId = null;

    // ========== UI æ¸²æŸ“ ==========
    function renderTabs(){
      const box = $("#tabs");
      box.innerHTML = "";
      TYPES.forEach(t=>{
        const b = el("div", "tab" + (t.id===currentType ? " active":""));
        b.textContent = `${t.icon} ${t.name}`;
        b.onclick = ()=>{ currentType=t.id; renderAll(); };
        box.appendChild(b);
      });
    }

    function groupsOptions(selected){
      return state.groups.map(g=>{
        const opt = document.createElement("option");
        opt.value = g; opt.textContent = g;
        if(g===selected) opt.selected = true;
        return opt;
      });
    }

    function renderForm(){
      const typeMeta = TYPES.find(x=>x.id===currentType);
      $("#formTitle").textContent = `${typeMeta.icon} æ–°å¢ Â· ${typeMeta.name}`;
      const wrap = $("#formFields");
      wrap.innerHTML = "";

      // åˆ†ç»„
      const fg = el("div","field");
      const lg = el("label"); lg.textContent = "åˆ†ç»„";
      const sg = document.createElement("select");
      sg.id = "groupSel";
      groupsOptions("é»˜è®¤").forEach(o=>sg.appendChild(o));
      fg.appendChild(lg); fg.appendChild(sg);
      wrap.appendChild(fg);

      // åŠ¨æ€å­—æ®µ
      SCHEMA[currentType].forEach(f=>{
        const fd = el("div","field");
        const lab = el("label"); lab.textContent = f.label + (f.req ? " *":"");
        let input;
        if(f.type==="textarea"){
          input = document.createElement("textarea");
          input.placeholder = f.ph || "";
        }else if(f.type==="select"){
          input = document.createElement("select");
          f.options.forEach(v=>{
            const o = document.createElement("option");
            o.value=v; o.textContent=v;
            if(f.def && f.def===v) o.selected=true;
            input.appendChild(o);
          });
        }else{
          input = document.createElement("input");
          input.type = f.type==="number" ? "number" : (f.type==="date" ? "date" : "text");
          input.placeholder = f.ph || "";
          if(f.type==="number") input.inputMode="decimal";
        }
        input.dataset.key = f.k;
        fd.appendChild(lab);
        fd.appendChild(input);
        wrap.appendChild(fd);
      });
    }

    function getFormData(){
      const data = {};
      // group
      const group = $("#groupSel").value || "é»˜è®¤";
      // fields
      const nodes = $("#formFields").querySelectorAll("[data-key]");
      nodes.forEach(n=>{
        let v = (n.value ?? "").toString().trim();
        data[n.dataset.key] = v;
      });
      // validate required
      const need = SCHEMA[currentType].filter(x=>x.req).map(x=>x.k);
      for(const k of need){
        if(!data[k] || data[k].length===0){
          const label = SCHEMA[currentType].find(x=>x.k===k).label;
          return { ok:false, msg:`è¯·å¡«å†™ï¼š${label}`, group, data };
        }
      }
      return { ok:true, group, data };
    }

    function resetForm(){
      renderForm();
      toast("å·²é‡ç½®");
    }

    function recordSummary(rec){
      // ç”¨æ›´â€œåƒä¾¿ç­¾â€çš„æ‘˜è¦
      const d = rec.data || {};
      if(rec.type==="snack"){
        const star = d.rating || "";
        return `${d.title || "ï¼ˆæœªå‘½åï¼‰"} ${star}`;
      }
      if(rec.type==="money"){
        const sign = (d.kind==="æ”¶å…¥") ? "+" : "-";
        const amt = d.amount ? `${sign}${d.amount}` : "";
        return `${d.title || "ï¼ˆæœªå‘½åï¼‰"} ${amt}`;
      }
      if(rec.type==="study"){
        const mins = d.mins ? `${d.mins}min` : "";
        return `${d.title || "ï¼ˆæœªå‘½åï¼‰"} ${mins}`;
      }
      if(rec.type==="todo"){
        const st = d.status || "";
        return `${d.title || "ï¼ˆæœªå‘½åï¼‰"} Â· ${st}`;
      }
      if(rec.type==="life"){
        return `${d.title || "ï¼ˆæœªå‘½åï¼‰"}`;
      }
      return d.title || "ï¼ˆè®°å½•ï¼‰";
    }

    function typeName(typeId){
      const t = TYPES.find(x=>x.id===typeId);
      return t ? `${t.icon} ${t.name}` : typeId;
    }

    function renderRecent(){
      $("#recentHint").textContent = `æ˜¾ç¤ºå½“å‰æ¨¡å—æœ€è¿‘ 5 æ¡ï¼ˆ${typeName(currentType)}ï¼‰`;
      const list = $("#recentList");
      list.innerHTML = "";

      const items = state.records
        .filter(r=>r.type===currentType)
        .slice()
        .sort((a,b)=> (b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt))
        .slice(0,5);

      if(items.length===0){
        const e = el("div","empty");
        e.textContent = "è¿˜æ²¡æœ‰è®°å½•ï½å…ˆåœ¨å·¦è¾¹æ–°å¢ä¸€æ¡å§ã€‚";
        list.appendChild(e);
        return;
      }

      items.forEach(rec=>{
        list.appendChild(renderItem(rec));
      });
    }

    function renderItem(rec){
      const it = el("div","item");
      const main = el("div","itMain");
      const title = el("div","itTitle");
      title.textContent = recordSummary(rec);

      const meta = el("div","itMeta");
      const c1 = el("span","chip type"); c1.textContent = typeName(rec.type);
      const c2 = el("span","chip group"); c2.textContent = rec.group || "é»˜è®¤";
      meta.appendChild(c1); meta.appendChild(c2);

      // snack æ˜¾ç¤ºæ˜Ÿæ˜Ÿ
      if(rec.type==="snack" && rec.data?.rating){
        const c3 = el("span","chip star"); c3.textContent = rec.data.rating;
        meta.appendChild(c3);
      }
      // todo æˆªæ­¢æ—¥æœŸ
      if(rec.type==="todo" && rec.data?.due){
        const c4 = el("span","chip"); c4.textContent = `æˆªæ­¢ ${rec.data.due}`;
        meta.appendChild(c4);
      }

      main.appendChild(title);
      main.appendChild(meta);

      const right = el("div","itRight");
      right.innerHTML = `<span class="mono">${fmtTime(rec.updatedAt||rec.createdAt)}</span><span>ç‚¹å¼€</span>`;

      it.appendChild(main);
      it.appendChild(right);

      it.onclick = ()=> openDetail(rec.id);
      return it;
    }

    // ========== è¯¦æƒ…/ç¼–è¾‘ ==========
    function openDetail(id){
      const rec = state.records.find(r=>r.id===id);
      if(!rec) return;
      editingId = id;

      $("#detailTitle").textContent = `âœï¸ ç¼–è¾‘ Â· ${typeName(rec.type)}`;
      const box = $("#detailFields");
      box.innerHTML = "";

      // group
      const fg = el("div","field");
      const lg = el("label"); lg.textContent = "åˆ†ç»„";
      const sg = document.createElement("select");
      sg.id = "edit_group";
      groupsOptions(rec.group || "é»˜è®¤").forEach(o=>sg.appendChild(o));
      fg.appendChild(lg); fg.appendChild(sg);
      box.appendChild(fg);

      SCHEMA[rec.type].forEach(f=>{
        const fd = el("div","field");
        const lab = el("label"); lab.textContent = f.label + (f.req ? " *":"");
        let input;
        if(f.type==="textarea"){
          input = document.createElement("textarea");
          input.value = rec.data?.[f.k] ?? "";
          input.placeholder = f.ph || "";
        }else if(f.type==="select"){
          input = document.createElement("select");
          f.options.forEach(v=>{
            const o = document.createElement("option");
            o.value=v; o.textContent=v;
            if((rec.data?.[f.k] ?? f.def)===v) o.selected=true;
            input.appendChild(o);
          });
        }else{
          input = document.createElement("input");
          input.type = f.type==="number" ? "number" : (f.type==="date" ? "date" : "text");
          input.value = rec.data?.[f.k] ?? "";
          input.placeholder = f.ph || "";
          if(f.type==="number") input.inputMode="decimal";
        }
        input.dataset.key = f.k;
        fd.appendChild(lab); fd.appendChild(input);
        box.appendChild(fd);
      });

      openMask("maskDetail");
    }

    function saveEdit(){
      const rec = state.records.find(r=>r.id===editingId);
      if(!rec) return;

      // validate
      const box = $("#detailFields");
      const group = ($("#edit_group").value || "é»˜è®¤");
      const data = {};
      box.querySelectorAll("[data-key]").forEach(n=>{
        data[n.dataset.key] = (n.value ?? "").toString().trim();
      });
      const need = SCHEMA[rec.type].filter(x=>x.req).map(x=>x.k);
      for(const k of need){
        if(!data[k] || data[k].length===0){
          const label = SCHEMA[rec.type].find(x=>x.k===k).label;
          toast(`è¯·å¡«å†™ï¼š${label}`);
          return;
        }
      }
      rec.group = group;
      rec.data = data;
      rec.updatedAt = nowISO();
      save();
      toast("å·²ä¿å­˜ä¿®æ”¹");
      closeMask("maskDetail");
      renderAll(); // åˆ·æ–°
    }

    function deleteRec(){
      if(!editingId) return;
      const idx = state.records.findIndex(r=>r.id===editingId);
      if(idx<0) return;
      state.records.splice(idx,1);
      save();
      toast("å·²åˆ é™¤");
      closeMask("maskDetail");
      renderAll();
    }

    // ========== å…¨éƒ¨è®°å½• ==========
    function openAll(){
      // å¡«å……ç­›é€‰ä¸‹æ‹‰
      const fType = $("#fType");
      const fGroup = $("#fGroup");
      fType.innerHTML = "";
      fGroup.innerHTML = "";

      const optAllType = document.createElement("option");
      optAllType.value = "__all__"; optAllType.textContent = "æ‰€æœ‰æ¨¡å—";
      fType.appendChild(optAllType);
      TYPES.forEach(t=>{
        const o = document.createElement("option");
        o.value = t.id; o.textContent = `${t.icon} ${t.name}`;
        fType.appendChild(o);
      });

      const optAllGroup = document.createElement("option");
      optAllGroup.value = "__all__"; optAllGroup.textContent = "æ‰€æœ‰åˆ†ç»„";
      fGroup.appendChild(optAllGroup);
      state.groups.forEach(g=>{
        const o = document.createElement("option");
        o.value = g; o.textContent = g;
        fGroup.appendChild(o);
      });

      // é»˜è®¤ï¼šå½“å‰æ¨¡å—
      fType.value = currentType;
      fGroup.value = "__all__";
      $("#q").value = "";

      renderAllList();
      openMask("maskAll");
      $("#q").focus();
    }

    function matchQuery(rec, q){
      if(!q) return true;
      q = q.toLowerCase();
      const parts = [];
      parts.push(rec.group || "");
      parts.push(typeName(rec.type));
      const d = rec.data || {};
      for(const k in d){ parts.push(String(d[k] ?? "")); }
      parts.push(rec.createdAt || "");
      parts.push(rec.updatedAt || "");
      return parts.join(" ").toLowerCase().includes(q);
    }

    function renderAllList(){
      const q = $("#q").value.trim();
      const t = $("#fType").value;
      const g = $("#fGroup").value;

      let arr = state.records.slice()
        .sort((a,b)=> (b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt));

      if(t !== "__all__") arr = arr.filter(x=>x.type===t);
      if(g !== "__all__") arr = arr.filter(x=> (x.group||"é»˜è®¤")===g);
      if(q) arr = arr.filter(x=>matchQuery(x,q));

      $("#allStat").textContent = `å…± ${arr.length} æ¡ï¼ˆæŒ‰æ›´æ–°æ—¶é—´å€’åºï¼‰`;
      const list = $("#allList");
      list.innerHTML = "";

      if(arr.length===0){
        const e = el("div","empty");
        e.textContent = "æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•ï½æ¢ä¸ªå…³é”®è¯è¯•è¯•ã€‚";
        list.appendChild(e);
        return;
      }
      arr.forEach(rec=> list.appendChild(renderItem(rec)));
    }

    // ========== åˆ†ç»„ ==========
    function openGroups(){
      renderGroups();
      openMask("maskGroups");
    }
    function renderGroups(){
      const list = $("#groupList");
      list.innerHTML = "";
      state.groups.forEach(g=>{
        const it = el("div","item");
        const main = el("div","itMain");
        const t = el("div","itTitle"); t.textContent = g;
        const meta = el("div","itMeta");
        const c = el("span","chip"); c.textContent = (g==="é»˜è®¤") ? "ä¸å¯åˆ é™¤" : "ç‚¹å‡»åˆ é™¤";
        meta.appendChild(c);
        main.appendChild(t); main.appendChild(meta);

        const right = el("div","itRight");
        right.textContent = "ğŸ—‘ï¸";
        it.appendChild(main); it.appendChild(right);

        it.onclick = ()=>{
          if(g==="é»˜è®¤"){ toast("é»˜è®¤åˆ†ç»„ä¸å¯åˆ é™¤"); return; }
          // æ£€æŸ¥æ˜¯å¦æœ‰è®°å½•åœ¨ç”¨
          const used = state.records.some(r=>(r.group||"é»˜è®¤")===g);
          if(used){
            toast("è¿™ä¸ªåˆ†ç»„é‡Œè¿˜æœ‰è®°å½•ï¼Œå…ˆæŠŠè®°å½•æ”¹åˆ°åˆ«çš„åˆ†ç»„å†åˆ ");
            return;
          }
          state.groups = state.groups.filter(x=>x!==g);
          save();
          toast("å·²åˆ é™¤åˆ†ç»„");
          renderGroups();
          renderForm(); // æ›´æ–°ä¸‹æ‹‰
        };
        list.appendChild(it);
      });
    }

    function addGroup(){
      const name = $("#newGroupName").value.trim();
      if(!name){ toast("è¯·è¾“å…¥åˆ†ç»„å"); return; }
      if(name.length>20){ toast("åˆ†ç»„ååˆ«å¤ªé•¿ï¼ˆâ‰¤20å­—ï¼‰"); return; }
      if(state.groups.includes(name)){ toast("è¿™ä¸ªåˆ†ç»„å·²å­˜åœ¨"); return; }
      state.groups.push(name);
      save();
      $("#newGroupName").value = "";
      toast("å·²æ·»åŠ åˆ†ç»„");
      renderGroups();
      renderForm();
    }

    // ========== æ–°å¢è®°å½• ==========
    function addRecord(){
      const got = getFormData();
      if(!got.ok){ toast(got.msg); return; }

      const rec = {
        id: uid(),
        type: currentType,
        group: got.group || "é»˜è®¤",
        data: got.data,
        createdAt: nowISO(),
        updatedAt: nowISO()
      };
      state.records.push(rec);
      save();
      toast("æ–°å¢æˆåŠŸ âœ…");
      resetForm();
      renderRecent();
    }

    // ========== å¯¼å…¥/å¯¼å‡º/æ¸…ç©º ==========
    function exportData(){
      const payload = JSON.stringify(state, null, 2);
      // ç”¨å¤åˆ¶æ–¹å¼ç»™æ‰‹æœº
      try{
        navigator.clipboard.writeText(payload).then(()=>{
          toast("å·²å¤åˆ¶å¤‡ä»½åˆ°å‰ªè´´æ¿");
        }).catch(()=>{
          fallbackCopy(payload);
        });
      }catch(e){
        fallbackCopy(payload);
      }
      function fallbackCopy(text){
        // å¼¹çª—å±•ç¤ºè®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
        const temp = el("textarea");
        temp.value = text;
        temp.style.position="fixed";
        temp.style.left="-9999px";
        document.body.appendChild(temp);
        temp.select();
        try{ document.execCommand("copy"); toast("å·²å¤åˆ¶å¤‡ä»½åˆ°å‰ªè´´æ¿"); }
        catch{ alert("å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨å¤åˆ¶\n\n" + text.slice(0,1000) + "\n...(å†…å®¹å¾ˆé•¿)"); }
        document.body.removeChild(temp);
      }
    }

    function importData(){
      const raw = prompt("æŠŠå¤‡ä»½ JSON ç²˜è´´åˆ°è¿™é‡Œï¼ˆå¾ˆé•¿ä¹Ÿæ²¡å…³ç³»ï¼‰");
      if(!raw) return;
      try{
        const obj = JSON.parse(raw);
        if(!obj || typeof obj!=="object") throw new Error("bad");
        if(!Array.isArray(obj.records)) throw new Error("bad");
        if(!Array.isArray(obj.groups)) obj.groups = ["é»˜è®¤"];
        if(!obj.groups.includes("é»˜è®¤")) obj.groups.unshift("é»˜è®¤");
        state = obj;
        save();
        toast("å¯¼å…¥æˆåŠŸ âœ…");
        renderAll();
      }catch(e){
        toast("å¯¼å…¥å¤±è´¥ï¼šä¸æ˜¯æœ‰æ•ˆçš„ JSON å¤‡ä»½");
      }
    }

    function wipe(){
      const ok = confirm("ç¡®è®¤æ¸…ç©ºå…¨éƒ¨æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼ˆé™¤éä½ ä¹‹å‰å¯¼å‡ºè¿‡å¤‡ä»½ï¼‰ã€‚");
      if(!ok) return;
      state = structuredClone(defaultData);
      save();
      toast("å·²æ¸…ç©º");
      renderAll();
    }

    // ========== æ€»æ¸²æŸ“ ==========
    function renderAll(){
      renderTabs();
      renderForm();
      renderRecent();
      // å¦‚æœâ€œå…¨éƒ¨è®°å½•â€çª—å£å¼€ç€ï¼Œä¹Ÿåˆ·æ–°å®ƒ
      if($("#maskAll").style.display==="flex") renderAllList();
    }

    // ========== ç»‘å®šäº‹ä»¶ ==========
    document.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-close]");
      if(btn){
        closeMask(btn.dataset.close);
      }
    });

    $("#btnAdd").onclick = addRecord;
    $("#btnAdd2").onclick = addRecord;
    $("#btnReset").onclick = resetForm;

    $("#btnAll").onclick = openAll;
    $("#btnAll2").onclick = openAll;
    $("#btnQuickAll").onclick = openAll;

    $("#btnGroups").onclick = openGroups;
    $("#btnAddGroup").onclick = addGroup;

    $("#btnBackup").onclick = exportData;
    $("#btnRestore").onclick = importData;
    $("#btnWipe").onclick = wipe;

    $("#btnSaveEdit").onclick = saveEdit;
    $("#btnDelete").onclick = deleteRec;

    // å…¨éƒ¨è®°å½•ç­›é€‰
    $("#q").addEventListener("input", ()=>renderAllList());
    $("#fType").addEventListener("change", ()=>renderAllList());
    $("#fGroup").addEventListener("change", ()=>renderAllList());

    // åˆå§‹
    renderAll();
  </script>
</body>
</html>
