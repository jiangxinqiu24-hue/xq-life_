<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å¿ƒç§‹å°ç”Ÿæ´»</title>
  <meta name="theme-color" content="#0b0b12" />
  <style>
    :root{
      --bg:#0b0b12;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.10);
      --text:#eaeaf2;
      --muted: rgba(234,234,242,.72);
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 24px;
      --accent1:#7c5cff;
      --accent2:#ff4d8d;
      --good:#3de7b6;
      --warn:#ffd166;
      --bad:#ff5c5c;
      --btn:#131322;
      --btn2:#19192b;
      --fontSerif: "Source Han Serif SC","Noto Serif CJK SC","Noto Serif SC","Songti SC","STSong","SimSun",serif;
      --fontSans: system-ui, -apple-system, "PingFang SC","Microsoft YaHei","Noto Sans CJK SC", sans-serif;
    }

    [data-theme="light"]{
      --bg:#f6f7fb;
      --panel: rgba(0,0,0,.05);
      --panel2: rgba(0,0,0,.07);
      --line: rgba(0,0,0,.08);
      --text:#111322;
      --muted: rgba(17,19,34,.62);
      --shadow: 0 18px 40px rgba(17,19,34,.12);
      --btn:#ffffff;
      --btn2:#ffffff;
    }
    [data-theme="purple"]{
      --bg:#0a0814;
      --panel: rgba(180,140,255,.10);
      --panel2: rgba(180,140,255,.14);
      --line: rgba(180,140,255,.18);
      --text:#f2efff;
      --muted: rgba(242,239,255,.72);
      --accent1:#b86bff;
      --accent2:#ff4dd8;
      --shadow: 0 18px 44px rgba(0,0,0,.45);
      --btn:#120f23;
      --btn2:#171233;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1100px 700px at 30% 0%, rgba(124,92,255,.22), transparent 60%),
                  radial-gradient(900px 620px at 95% 15%, rgba(255,77,141,.18), transparent 55%),
                  radial-gradient(900px 700px at 50% 110%, rgba(61,231,182,.12), transparent 65%),
                  var(--bg);
      color:var(--text);
      font-family: var(--fontSans);
      -webkit-tap-highlight-color: transparent;
    }
    a{color:inherit}
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 120px;
    }
    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px;
      margin: 8px 2px 14px;
    }
    .title{display:flex; flex-direction:column; gap:6px;}
    .title h1{margin:0;font-size:24px;letter-spacing:.5px;}
    .subtitle{
      color:var(--muted);
      font-size: 12px;
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    .pillRow{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .pill button, .pill select{
      border:none; outline:none;
      background:transparent;
      color:var(--text);
      font-size: 12px;
    }
    .pill select{appearance:none}

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media (min-width:720px){
      .grid{grid-template-columns: 1.1fr .9fr}
    }

    .card{
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom: 1px solid var(--line);
    }
    .cardHeader h2{margin:0;font-size:15px;letter-spacing:.3px;}
    .cardHeader .hint{color:var(--muted); font-size:12px; margin-top:6px}
    .cardBody{padding:14px}

    .homeCards{
      display:grid; grid-template-columns: 1fr; gap:12px;
    }
    @media (min-width:520px){
      .homeCards{grid-template-columns: 1fr 1fr}
    }
    .mini{
      padding:14px;
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background: rgba(0,0,0,.10);
      display:flex; flex-direction:column; gap:8px;
      cursor:pointer;
    }
    [data-theme="light"] .mini{background: rgba(255,255,255,.85)}
    .mini .k{display:flex; align-items:center; justify-content:space-between}
    .mini .k b{font-size:14px}
    .mini .k span{font-size:18px}
    .mini .d{color:var(--muted); font-size:12px; line-height:1.35}
    .mini .tag{font-size:12px; color:var(--muted)}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      border:none; outline:none;
      color:var(--text);
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      border:1px solid var(--line);
      border-radius: 14px;
      padding:12px 14px;
      font-size: 13px;
      cursor:pointer;
      box-shadow: var(--shadow);
    }
    .btn.primary{
      border:none;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color:white;
      font-weight:600;
    }
    .btn.ghost{background: transparent;}
    .btn.danger{
      background: linear-gradient(90deg, rgba(255,92,92,.9), rgba(255,77,141,.9));
      color:white;
      border:none;
    }

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .tab{
      padding:10px 12px;
      border-radius: 999px;
      background: transparent;
      border: 1px solid var(--line);
      color: var(--muted);
      cursor:pointer;
      font-size: 12px;
    }
    .tab.active{
      color: var(--text);
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      box-shadow: var(--shadow);
    }

    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.10);
      color: var(--text);
      padding:12px 12px;
      font-size: 14px;
      outline:none;
    }
    [data-theme="light"] input,[data-theme="light"] select,[data-theme="light"] textarea{
      background: rgba(255,255,255,.9);
    }
    textarea{min-height: 92px; resize: vertical}
    .req::after{content:" *"; color: var(--accent2)}
    .row2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}

    .list{display:flex; flex-direction:column; gap:10px;}
    .item{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(0,0,0,.10);
      padding:12px 12px;
      display:flex; flex-direction:column; gap:8px;
    }
    [data-theme="light"] .item{background: rgba(255,255,255,.86)}
    .itemTop{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .meta{
      color:var(--muted); font-size:12px; display:flex; gap:10px; flex-wrap:wrap
    }
    .itemTitle{
      font-size: 14px;
      font-family: var(--fontSerif);
      letter-spacing:.2px;
      line-height:1.35;
      margin:0;
    }
    .itemNote{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.45;
      white-space: pre-wrap;
    }

    .actions{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    .iconBtn{
      border:1px solid var(--line);
      background: transparent;
      color: var(--text);
      border-radius: 12px;
      padding:9px 10px;
      font-size: 12px;
      cursor:pointer;
    }
    .star.on{border:none; background: linear-gradient(90deg, rgba(255,209,102,.95), rgba(255,77,141,.85)); color:#111}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
    }

    .footerBar{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
      background: rgba(15,15,22,.86);
      border-top: 1px solid var(--line);
      backdrop-filter: blur(14px);
      z-index: 30;
    }
    [data-theme="light"] .footerBar{background: rgba(246,247,251,.90)}
    .footerInner{
      max-width: 980px; margin: 0 auto;
      display:flex; gap:10px; justify-content:space-between;
    }
    .footerInner .btn{flex:1}

    .modalMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 18px 12px calc(18px + env(safe-area-inset-bottom));
      z-index: 60;
    }
    .modalMask.show{display:flex}
    .modal{
      width: min(980px, 100%);
      border-radius: 26px;
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
      max-height: 86vh;
      display:flex; flex-direction:column;
    }
    .modalHead{
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid var(--line);
    }
    .modalHead strong{font-size:14px}
    .modalBody{padding:14px; overflow:auto}

    .folderGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (min-width:520px){
      .folderGrid{grid-template-columns: 1fr 1fr 1fr}
    }
    .folder{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding:14px;
      background: rgba(0,0,0,.10);
      cursor:pointer;
      display:flex; flex-direction:column; gap:8px;
      min-height: 92px;
    }
    [data-theme="light"] .folder{background: rgba(255,255,255,.86)}
    .folder b{font-size:14px}
    .folder .small{color:var(--muted); font-size:12px}
    .folder .count{margin-top:auto; color:var(--muted); font-size:12px}

    .toast{
      position:fixed; left:50%; bottom: 96px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.8);
      color:#fff;
      padding:10px 12px;
      border-radius: 999px;
      font-size: 12px;
      display:none;
      z-index: 80;
    }
    [data-theme="light"] .toast{background: rgba(17,19,34,.86)}
    .toast.show{display:block}

    .searchRow{display:flex; gap:10px; align-items:center}
    .searchRow input{flex:1}

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      color:var(--muted)
    }

    /* Simple confirm/prompt fallback (mobile friendly) */
    .dlgMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px 12px;
      z-index: 90;
    }
    .dlgMask.show{display:flex}
    .dlg{
      width:min(520px,100%);
      border-radius: 22px;
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .dlgHead{padding:14px 14px 10px; border-bottom:1px solid var(--line)}
    .dlgHead strong{font-size:14px}
    .dlgBody{padding:14px}
    .dlgFoot{padding:14px; border-top:1px solid var(--line); display:flex; gap:10px}
    .dlgFoot .btn{flex:1}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <div class="topbar">
      <div class="title">
        <h1>å¿ƒç§‹å°ç”Ÿæ´»</h1>
        <div class="subtitle">
          <span id="subTime">â€”</span>
          <span class="chip" id="chipInfo">æœ¬åœ°ä¿å­˜ Â· å¸¦ç¼–è¾‘å†å²</span>
        </div>
      </div>

      <div class="pillRow">
        <div class="pill">
          <span style="font-size:12px;color:var(--muted)">ä¸»é¢˜</span>
          <select id="themeSel">
            <option value="dark">æ·±è‰²</option>
            <option value="purple">ç´«è‰²</option>
            <option value="light">æµ…è‰²</option>
          </select>
        </div>
        <div class="pill">
          <button id="btnExport">å¯¼å‡ºå¤‡ä»½</button>
          <span style="opacity:.4">|</span>
          <button id="btnImport">å¯¼å…¥å¤‡ä»½</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h2>ä¸»é¡µ</h2>
            <div class="hint">åƒä¾¿ç­¾ä¸€æ ·ï¼šå¿«è®°ã€å¯åˆ†ç»„ã€å¯æ”¶è—ã€å¯ç»Ÿè®¡ã€‚</div>
          </div>
          <div class="btnRow">
            <button class="btn ghost" id="btnAll">ğŸ“š å…¨éƒ¨è®°å½•</button>
            <button class="btn ghost" id="btnGroups">ğŸ—‚ï¸ åˆ†ç»„</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="homeCards" id="homeCards"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div>
            <h2>ä»Šæ—¥æ€»ç»“</h2>
            <div class="hint">ä¸€é”®ç”Ÿæˆä»Šæ—¥å°ç»“ï¼Œå¯å¤åˆ¶ã€‚</div>
          </div>
          <div class="btnRow">
            <button class="btn" id="btnGenSummary">ç”Ÿæˆ</button>
            <button class="btn primary" id="btnCopySummary">å¤åˆ¶</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="mono" id="summaryBox">ç‚¹â€œç”Ÿæˆâ€å°±ä¼šå‡ºç°ä»Šæ—¥å°ç»“ï½</div>
        </div>
      </div>
    </div>
  </div>

  <div class="footerBar">
    <div class="footerInner">
      <button class="btn primary" id="btnAdd">æ–°å¢</button>
      <button class="btn" id="btnToday">ä»Šå¤©</button>
    </div>
  </div>

  <!-- Main modal -->
  <div class="modalMask" id="mask">
    <div class="modal">
      <div class="modalHead">
        <strong id="modalTitle">â€”</strong>
        <div class="btnRow">
          <button class="btn" id="btnClose">å…³é—­</button>
        </div>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <!-- Dialog modal -->
  <div class="dlgMask" id="dlgMask">
    <div class="dlg">
      <div class="dlgHead"><strong id="dlgTitle">æç¤º</strong></div>
      <div class="dlgBody" id="dlgBody"></div>
      <div class="dlgFoot">
        <button class="btn" id="dlgCancel">å–æ¶ˆ</button>
        <button class="btn primary" id="dlgOk">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">å·²å¤åˆ¶</div>

<script>
(() => {
  const $ = (q, el=document) => el.querySelector(q);
  const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

  const LS_KEY = "xq_life_v2";
  const LS_THEME = "xq_theme_v2";

  const now = () => new Date();
  const pad = n => String(n).padStart(2,"0");
  const fmtDate = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const fmtTime = (d) => `${pad(d.getHours())}:${pad(d.getMinutes())}`;
  const fmtDT = (d) => `${fmtDate(d)} ${fmtTime(d)}`;
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  const toast = (msg="å·²å®Œæˆ") => {
    const t = $("#toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1200);
  };

  const safeJsonParse = (s, fallback) => { try { return JSON.parse(s); } catch { return fallback; } };

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g, "&quot;"); }

  const defaultState = () => ({
    version: 2,
    groups: [
      { id:"g_default", name:"é»˜è®¤ğŸ“Œ" },
      { id:"g_food", name:"åƒåƒåƒğŸ˜‹" },
      { id:"g_study", name:"å­¦ä¹ ğŸ’ª" },
      { id:"g_life", name:"ç”Ÿæ´»è®°å½•ğŸŒ™" },
    ],
    records: []
  });

  const loadState = () => {
    const raw = localStorage.getItem(LS_KEY);
    const st = raw ? safeJsonParse(raw, null) : null;
    if (!st || !st.version) return defaultState();
    if (!st.groups) st.groups = defaultState().groups;
    if (!Array.isArray(st.records)) st.records = [];
    return st;
  };

  const saveState = (st) => localStorage.setItem(LS_KEY, JSON.stringify(st));

  const setTheme = (theme) => {
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem(LS_THEME, theme);
    const themeColor = theme === "light" ? "#f6f7fb" : (theme === "purple" ? "#0a0814" : "#0b0b12");
    const meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute("content", themeColor);
  };

  const initTheme = () => {
    const t = localStorage.getItem(LS_THEME) || "dark";
    setTheme(t);
    $("#themeSel").value = t;
    $("#themeSel").addEventListener("change", e => setTheme(e.target.value));
  };

  // ---- Mobile-friendly dialog (replaces prompt/confirm) ----
  let dlgResolve = null;
  const showDialog = ({title="æç¤º", bodyHTML="", showCancel=true, okText="ç¡®å®š", cancelText="å–æ¶ˆ"}) => {
    $("#dlgTitle").textContent = title;
    $("#dlgBody").innerHTML = bodyHTML;
    $("#dlgOk").textContent = okText;
    $("#dlgCancel").textContent = cancelText;
    $("#dlgCancel").style.display = showCancel ? "" : "none";
    $("#dlgMask").classList.add("show");
    return new Promise(res => { dlgResolve = res; });
  };
  const closeDialog = () => {
    $("#dlgMask").classList.remove("show");
  };
  $("#dlgOk").addEventListener("click", () => { const r = dlgResolve; dlgResolve=null; closeDialog(); r && r({ok:true}); });
  $("#dlgCancel").addEventListener("click", () => { const r = dlgResolve; dlgResolve=null; closeDialog(); r && r({ok:false}); });
  $("#dlgMask").addEventListener("click", (e)=>{ if(e.target.id==="dlgMask"){ const r = dlgResolve; dlgResolve=null; closeDialog(); r && r({ok:false}); }});

  const askText = async (title, placeholder, defaultValue="") => {
    const id = "dlgInput_" + uid();
    const ret = await showDialog({
      title,
      bodyHTML: `
        <div class="mono" style="margin-bottom:10px">${escapeHtml(placeholder||"")}</div>
        <input id="${id}" value="${escapeAttr(defaultValue)}" placeholder="${escapeAttr(placeholder||"")}" />
      `,
      showCancel:true,
      okText:"ä¿å­˜"
    });
    if(!ret.ok) return null;
    const v = ($("#"+id)?.value || "").trim();
    return v || null;
  };

  const askConfirm = async (title, content) => {
    const ret = await showDialog({
      title,
      bodyHTML:`<div style="line-height:1.5">${escapeHtml(content||"")}</div>`,
      showCancel:true,
      okText:"ç¡®å®š"
    });
    return !!ret.ok;
  };

  // ---- App state ----
  let state = loadState();

  const groupName = (gid) => (state.groups.find(g=>g.id===gid)?.name) || "æœªåˆ†ç»„";
  const typeName = (t) => ({
    snack:"ğŸª é›¶é£Ÿè¯„åˆ†",
    expense:"ğŸ’° è®°è´¦",
    study:"ğŸ“š å­¦ä¹ æ‰“å¡",
    todo:"âœ… ä»£åŠæ¸…å•",
    life:"ğŸŒ™ ç”Ÿæ´»è®°å½•",
  }[t] || t);

  const homeModules = [
    { type:"snack",  title:"é›¶é£Ÿè¯„åˆ†", icon:"ğŸª", desc:"è®°å½•é›¶é£Ÿã€æ¸ é“ã€æ˜Ÿçº§ã€å¤‡æ³¨ï¼›æ”¯æŒæ”¶è—â­ã€‚"},
    { type:"expense",title:"è®°è´¦",     icon:"ğŸ’°", desc:"å¿«é€Ÿè®°ä¸€ç¬”é’±ï¼šé‡‘é¢+åˆ†ç±»/æ¥æº+å¤‡æ³¨ã€‚"},
    { type:"study",  title:"å­¦ä¹ æ‰“å¡", icon:"ğŸ“š", desc:"è®°å½•å­¦ä¹ å†…å®¹å’Œç”¨æ—¶ï¼Œå¤ç›˜æ›´æ¸…æ¥šã€‚"},
    { type:"todo",   title:"ä»£åŠæ¸…å•", icon:"âœ…", desc:"å†™å¾…åŠã€æ ‡å®Œæˆï¼Œåˆ«è®©è„‘å­å½“è®°äº‹æœ¬ã€‚"},
    { type:"life",   title:"ç”Ÿæ´»è®°å½•", icon:"ğŸŒ™", desc:"åƒä¾¿ç­¾ä¸€æ ·å†™ä¸€æ®µï¼šä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆã€‚"},
  ];

  const newRecord = (type) => ({
    id: uid(),
    type,
    groupId: "g_default",
    title: "",
    source: "",
    stars: 3,
    amount: 0,
    minutes: 0,
    note: "",
    done: false,
    fav: false,
    createdAt: Date.now(),
    updatedAt: Date.now(),
    history: []
  });

  const pushHistory = (rec, patch) => {
    rec.history = rec.history || [];
    rec.history.unshift({ at: Date.now(), patch });
    if (rec.history.length > 50) rec.history.pop();
  };

  const upsertRecord = (rec) => {
    rec.updatedAt = Date.now();
    const idx = state.records.findIndex(r => r.id === rec.id);
    if (idx >= 0) state.records[idx] = rec;
    else state.records.unshift(rec);
    saveState(state);
  };

  const deleteRecord = (id) => {
    state.records = state.records.filter(r => r.id !== id);
    saveState(state);
  };

  const findRecord = (id) => state.records.find(r=>r.id===id);

  // ---- Export/Import ----
  const downloadText = (filename, text) => {
    const blob = new Blob([text], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  };

  $("#btnExport").addEventListener("click", () => {
    const data = JSON.stringify(state, null, 2);
    downloadText(`xq-life-backup-${fmtDate(now())}.json`, data);
    toast("å·²å¯¼å‡ºå¤‡ä»½");
  });

  $("#btnImport").addEventListener("click", () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = async () => {
      const f = input.files?.[0];
      if (!f) return;
      const txt = await f.text();
      const obj = safeJsonParse(txt, null);
      if (!obj || !obj.records) { toast("å¤‡ä»½æ–‡ä»¶ä¸å¯¹"); return; }
      state = obj;
      if (!state.groups) state.groups = defaultState().groups;
      saveState(state);
      renderHome();
      toast("å·²å¯¼å…¥");
    };
    input.click();
  });

  // ---- Main modal ----
  const openModal = (title, html) => {
    $("#modalTitle").textContent = title;
    $("#modalBody").innerHTML = html;

    // IMPORTANT: modal content is injected now, so bind after injection
    bindModalEvents();

    $("#mask").classList.add("show");
  };
  const closeModal = () => $("#mask").classList.remove("show");
  $("#btnClose").addEventListener("click", closeModal);
  $("#mask").addEventListener("click", (e) => { if (e.target.id === "mask") closeModal(); });

  // ---- Summary ----
  const buildTodaySummary = () => {
    const d = fmtDate(now());
    const today = state.records.filter(r => fmtDate(new Date(r.createdAt)) === d);

    const exp = today.filter(r=>r.type==="expense");
    const sumExp = exp.reduce((a,b)=>a+(Number(b.amount)||0),0);

    const study = today.filter(r=>r.type==="study");
    const sumMin = study.reduce((a,b)=>a+(Number(b.minutes)||0),0);

    const snacks = today.filter(r=>r.type==="snack");
    const topSnack = [...snacks].sort((a,b)=>(b.stars||0)-(a.stars||0))[0];

    const todos = today.filter(r=>r.type==="todo");
    const done = todos.filter(t=>t.done).length;

    const life = today.filter(r=>r.type==="life");

    const lines = [];
    lines.push(`ğŸ“… ä»Šæ—¥å°ç»“ï¼š${d}`);
    lines.push(``);
    lines.push(`ğŸ’° èŠ±é”€ï¼š${sumExp.toFixed(2)} å…ƒï¼ˆ${exp.length} æ¡ï¼‰`);
    lines.push(`ğŸ“š å­¦ä¹ ï¼š${Math.floor(sumMin/60)} å°æ—¶ ${sumMin%60} åˆ†ï¼ˆ${study.length} æ¡ï¼‰`);
    lines.push(`âœ… å¾…åŠï¼šå®Œæˆ ${done}/${todos.length}`);
    lines.push(`ğŸª é›¶é£Ÿï¼š${snacks.length} æ¡${topSnack ? `ï¼Œæœ€å–œæ¬¢ï¼š${topSnack.title}ï¼ˆ${topSnack.stars}â­ï¼‰` : ""}`);
    lines.push(`ğŸŒ™ ç”Ÿæ´»è®°å½•ï¼š${life.length} æ¡`);
    lines.push(``);
    if (today.length === 0) lines.push(`ä»Šå¤©è¿˜æ²¡è®°å½•å‘¢ï½å†™ä¸€å¥ä¹Ÿç®—å¼€å§‹ã€‚`);
    return lines.join("\n");
  };

  $("#btnGenSummary").addEventListener("click", () => {
    $("#summaryBox").textContent = buildTodaySummary();
    toast("å·²ç”Ÿæˆ");
  });

  $("#btnCopySummary").addEventListener("click", async () => {
    const text = $("#summaryBox").textContent || "";
    try{
      await navigator.clipboard.writeText(text);
      toast("å·²å¤åˆ¶");
    }catch{
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("å·²å¤åˆ¶");
    }
  });

  // ---- Time label ----
  const tick = () => {
    const d = now();
    $("#subTime").textContent = `ç°åœ¨ï¼š${fmtDT(d)}`;
  };
  setInterval(tick, 1000 * 15); tick();

  // ---- Render home ----
  const renderHome = () => {
    const el = $("#homeCards");
    const counts = Object.fromEntries(homeModules.map(m => [m.type, state.records.filter(r=>r.type===m.type).length]));
    el.innerHTML = homeModules.map(m => `
      <div class="mini" data-open="${m.type}">
        <div class="k">
          <b>${m.icon} ${m.title}</b>
          <span>${counts[m.type] || 0}</span>
        </div>
        <div class="d">${escapeHtml(m.desc)}</div>
        <div class="tag">ç‚¹æˆ‘æ–°å¢ / æŸ¥çœ‹</div>
      </div>
    `).join("");

    $$(".mini[data-open]").forEach(x=>{
      x.addEventListener("click", ()=> openAdd(x.getAttribute("data-open")));
    });
  };

  const openAdd = (type) => {
    const rec = newRecord(type);
    openEditModal(rec, true);
  };

  const renderHistory = (rec) => {
    const rows = (rec.history || []).map(h=>{
      const when = fmtDT(new Date(h.at));
      const keys = Object.keys(h.patch || {});
      const body = keys.map(k => `â€¢ ${k}: ${String(h.patch[k]).slice(0,120)}`).join("\n");
      return `<div class="item">
        <div class="meta">${escapeHtml(when)}</div>
        <pre class="mono" style="white-space:pre-wrap;margin:0">${escapeHtml(body || "ï¼ˆæ— å˜æ›´è¯¦æƒ…ï¼‰")}</pre>
      </div>`;
    }).join("");
    return `<div class="list">${rows || `<div class="mono">æš‚æ— å†å²</div>`}</div>`;
  };

  function diffPatch(before, after){
    const keys = ["type","groupId","title","source","stars","amount","minutes","note","done","fav"];
    const patch = {};
    keys.forEach(k=>{
      const a = before?.[k];
      const b = after?.[k];
      if (JSON.stringify(a) !== JSON.stringify(b)) patch[k] = b;
    });
    return patch;
  }

  const openEditModal = (rec, isNew=false) => {
    const groupOptions = state.groups.map(g => `<option value="${g.id}" ${g.id===rec.groupId?"selected":""}>${escapeHtml(g.name)}</option>`).join("");

    const baseTop = `
      <div class="tabs">
        ${homeModules.map(m => `<button class="tab ${rec.type===m.type?"active":""}" data-type="${m.type}">${m.icon} ${m.title}</button>`).join("")}
      </div>
      <div class="row2">
        <div>
          <label>åˆ†ç»„</label>
          <select id="f_group">${groupOptions}</select>
        </div>
        <div>
          <label>æ”¶è—</label>
          <button class="btn ${rec.fav?"primary":""}" id="f_fav">${rec.fav?"â­ å·²æ”¶è—":"â˜† ç‚¹æˆ‘æ”¶è—"}</button>
        </div>
      </div>
    `;

    const fields = (() => {
      if (rec.type === "snack") return `
        <label class="req">é›¶é£Ÿåç§°</label>
        <input id="f_title" value="${escapeAttr(rec.title)}" placeholder="ä¾‹å¦‚ï¼šæµ·è‹”è‚‰æ¾å°è´" />

        <label>åº—é“º/æ¥æº</label>
        <input id="f_source" value="${escapeAttr(rec.source)}" placeholder="ä¾‹å¦‚ï¼šé›¶é£Ÿæœ‰é¸£ / ç½‘è´­ / è¶…å¸‚" />

        <label class="req">å–œçˆ±ç¨‹åº¦ï¼ˆ1-5â­ï¼‰</label>
        <select id="f_stars">
          ${[1,2,3,4,5].map(s => `<option value="${s}" ${Number(rec.stars)===s?"selected":""}>${s}â­</option>`).join("")}
        </select>

        <label>å¤‡æ³¨</label>
        <textarea id="f_note" placeholder="å£æ„Ÿ/ç”œåº¦/å›è´­ï¼Ÿ">${escapeHtml(rec.note||"")}</textarea>
      `;

      if (rec.type === "expense") return `
        <label class="req">èŠ±é”€æ ‡é¢˜</label>
        <input id="f_title" value="${escapeAttr(rec.title)}" placeholder="ä¾‹å¦‚ï¼šå¥¶èŒ¶ / æ‰“è½¦ / çŒ«ç²®" />

        <div class="row2">
          <div>
            <label class="req">é‡‘é¢ï¼ˆå…ƒï¼‰</label>
            <input id="f_amount" type="number" inputmode="decimal" value="${Number(rec.amount||0)}" />
          </div>
          <div>
            <label>æ¥æº/åˆ†ç±»</label>
            <input id="f_source" value="${escapeAttr(rec.source)}" placeholder="ä¾‹å¦‚ï¼šå¤–å– / è¶…å¸‚ / äº¤é€š" />
          </div>
        </div>

        <label>å¤‡æ³¨</label>
        <textarea id="f_note" placeholder="ä¾‹å¦‚ï¼šç”¨åˆ¸çœäº†å¤šå°‘ï¼Ÿ">${escapeHtml(rec.note||"")}</textarea>
      `;

      if (rec.type === "study") return `
        <label class="req">å­¦ä¹ å†…å®¹</label>
        <input id="f_title" value="${escapeAttr(rec.title)}" placeholder="ä¾‹å¦‚ï¼šå†å²é€‰æ‹©é¢˜Â·è¿‘ä»£å²" />

        <div class="row2">
          <div>
            <label class="req">å­¦ä¹ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
            <input id="f_minutes" type="number" inputmode="numeric" value="${Number(rec.minutes||0)}" />
          </div>
          <div>
            <label>ç§‘ç›®/æ¥æº</label>
            <input id="f_source" value="${escapeAttr(rec.source)}" placeholder="ä¾‹å¦‚ï¼šå†å² / æ”¿æ²» / è‹±è¯­" />
          </div>
        </div>

        <label>å¤ç›˜/å¿ƒå¾—</label>
        <textarea id="f_note" placeholder="ä»Šå¤©å¡ä½äº†ä»€ä¹ˆï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ">${escapeHtml(rec.note||"")}</textarea>
      `;

      if (rec.type === "todo") return `
        <label class="req">å¾…åŠäº‹é¡¹</label>
        <input id="f_title" value="${escapeAttr(rec.title)}" placeholder="ä¾‹å¦‚ï¼šå¸¦æ¢¨èŠ±æ‰“ç–«è‹—" />

        <div class="row2">
          <div>
            <label>çŠ¶æ€</label>
            <button class="btn ${rec.done?"primary":""}" id="f_done">${rec.done?"âœ… å·²å®Œæˆ":"â¬œ æœªå®Œæˆ"}</button>
          </div>
          <div>
            <label>æ ‡ç­¾/æ¥æº</label>
            <input id="f_source" value="${escapeAttr(rec.source)}" placeholder="ä¾‹å¦‚ï¼šçŒ«å’ª / å·¥ä½œ / å­¦ä¹ " />
          </div>
        </div>

        <label>å¤‡æ³¨</label>
        <textarea id="f_note" placeholder="å¤‡æ³¨/æé†’">${escapeHtml(rec.note||"")}</textarea>
      `;

      return `
        <label class="req">æ ‡é¢˜</label>
        <input id="f_title" value="${escapeAttr(rec.title)}" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©ä¸‹ç­çœ‹åˆ°çš„æœˆäº®" />

        <label>å†…å®¹</label>
        <textarea id="f_note" placeholder="éšæ‰‹è®°ï¼š">${escapeHtml(rec.note||"")}</textarea>

        <label>æ ‡ç­¾/æ¥æº</label>
        <input id="f_source" value="${escapeAttr(rec.source)}" placeholder="ä¾‹å¦‚ï¼šå¿ƒæƒ… / å·¥ä½œ / æœ‹å‹" />
      `;
    })();

    const historyBtn = rec.history?.length ? `<button class="btn" data-act="history" data-id="${rec.id}">ç¼–è¾‘å†å²</button>` : "";
    const dangerBtn = isNew ? "" : `<button class="btn danger" data-act="delete" data-id="${rec.id}">åˆ é™¤</button>`;

    openModal(`${isNew?"âœï¸ æ–°å¢":"âœï¸ ç¼–è¾‘"} Â· ${typeName(rec.type)}`, `
      <div data-scope="editor" data-id="${rec.id}">
        ${baseTop}
        ${fields}
        <div style="height:10px"></div>
        <div class="btnRow">
          <button class="btn primary" data-act="save" data-id="${rec.id}">ä¿å­˜</button>
          ${historyBtn}
          ${dangerBtn}
        </div>
        <div class="mono" style="margin-top:10px">æ–°å¢åå¯åœ¨â€œå…¨éƒ¨è®°å½•/åˆ†ç»„â€ä¸­æŸ¥çœ‹ä¸ç¼–è¾‘ï¼ˆæ¯æ¬¡ä¿®æ”¹ä¼šè®°å½•æ—¶é—´ï¼‰</div>
      </div>
    `);

    // Attach current working record to window map
    working.set(rec.id, rec);
  };

  // ---- Working records map (fix: ensure edits refer to right record) ----
  const working = new Map(); // id -> record object (editable)

  // ---- List rendering ----
  const renderItem = (r) => {
    const when = fmtDT(new Date(r.createdAt));
    const g = groupName(r.groupId);
    const tag = typeName(r.type);

    let extra = "";
    if (r.type === "snack") extra = `${r.stars||0}â­ Â· ${(r.source||"")}`;
    if (r.type === "expense") extra = `${Number(r.amount||0).toFixed(2)} å…ƒ Â· ${(r.source||"")}`;
    if (r.type === "study") extra = `${r.minutes||0} åˆ† Â· ${(r.source||"")}`;
    if (r.type === "todo") extra = `${r.done?"âœ… å·²å®Œæˆ":"â¬œ æœªå®Œæˆ"} Â· ${(r.source||"")}`;
    if (r.type === "life") extra = `${(r.source||"")}`;

    return `
      <div class="item">
        <div class="itemTop">
          <div>
            <div class="meta">${escapeHtml(tag)} Â· ${escapeHtml(g)} Â· ${escapeHtml(when)}</div>
            <p class="itemTitle">${escapeHtml(r.title || "(æ— æ ‡é¢˜)")}</p>
          </div>
          <div class="actions">
            <button class="iconBtn star ${r.fav?"on":""}" data-act="star" data-id="${r.id}">${r.fav?"â­":"â˜†"}</button>
            <button class="iconBtn" data-act="edit" data-id="${r.id}">ç¼–è¾‘</button>
          </div>
        </div>
        ${extra ? `<div class="meta">${escapeHtml(extra)}</div>` : ""}
        ${r.note ? `<p class="itemNote">${escapeHtml(r.note)}</p>` : ""}
      </div>
    `;
  };

  const renderStats = () => {
    const total = state.records.length;
    const byType = Object.fromEntries(homeModules.map(m => [m.type, state.records.filter(r=>r.type===m.type).length]));
    const fav = state.records.filter(r=>r.fav).length;

    const snacks = state.records.filter(r=>r.type==="snack");
    const avgStar = snacks.length ? (snacks.reduce((a,b)=>a+(b.stars||0),0)/snacks.length).toFixed(2) : "â€”";

    const exps = state.records.filter(r=>r.type==="expense");
    const sumExp = exps.reduce((a,b)=>a+(Number(b.amount)||0),0);

    const study = state.records.filter(r=>r.type==="study");
    const sumMin = study.reduce((a,b)=>a+(Number(b.minutes)||0),0);

    return `
      <div class="list">
        <div class="item">
          <p class="itemTitle">æ€»è®°å½•ï¼š${total} æ¡ Â· æ”¶è—ï¼š${fav} æ¡</p>
          <p class="itemNote">é›¶é£Ÿ ${byType.snack||0} Â· è®°è´¦ ${byType.expense||0} Â· å­¦ä¹  ${byType.study||0} Â· å¾…åŠ ${byType.todo||0} Â· ç”Ÿæ´» ${byType.life||0}</p>
        </div>

        <div class="item">
          <p class="itemTitle">ğŸª é›¶é£Ÿç»Ÿè®¡</p>
          <p class="itemNote">å¹³å‡å–œçˆ±ï¼š${avgStar}â­ï¼ˆå…± ${snacks.length} æ¡ï¼‰</p>
        </div>

        <div class="item">
          <p class="itemTitle">ğŸ’° è®°è´¦ç»Ÿè®¡</p>
          <p class="itemNote">ç´¯è®¡æ”¯å‡ºï¼š${sumExp.toFixed(2)} å…ƒï¼ˆå…± ${exps.length} æ¡ï¼‰</p>
        </div>

        <div class="item">
          <p class="itemTitle">ğŸ“š å­¦ä¹ ç»Ÿè®¡</p>
          <p class="itemNote">ç´¯è®¡å­¦ä¹ ï¼š${Math.floor(sumMin/60)} å°æ—¶ ${sumMin%60} åˆ†ï¼ˆå…± ${study.length} æ¡ï¼‰</p>
        </div>
      </div>
    `;
  };

  const openAllRecords = () => {
    const html = `
      <div class="tabs">
        <button class="tab active" data-filter="all">å…¨éƒ¨</button>
        <button class="tab" data-filter="fav">â­ æ”¶è—</button>
        ${homeModules.map(m => `<button class="tab" data-filter="${m.type}">${m.icon} ${m.title}</button>`).join("")}
      </div>

      <div class="searchRow">
        <input id="q" placeholder="æœç´¢ï¼šæ ‡é¢˜/å¤‡æ³¨/æ¥æº/åˆ†ç»„â€¦" />
        <button class="btn" data-act="stats">ç»Ÿè®¡</button>
      </div>

      <div style="height:10px"></div>
      <div class="list" id="listBox"></div>
    `;
    openModal("ğŸ“š å…¨éƒ¨è®°å½•", html);

    let filter = "all";
    let keyword = "";

    const render = () => {
      const listEl = $("#listBox");
      let arr = [...state.records];

      if (filter === "fav") arr = arr.filter(r=>r.fav);
      else if (filter !== "all") arr = arr.filter(r=>r.type === filter);

      if (keyword.trim()){
        const k = keyword.trim().toLowerCase();
        arr = arr.filter(r => (
          (r.title||"").toLowerCase().includes(k) ||
          (r.note||"").toLowerCase().includes(k) ||
          (r.source||"").toLowerCase().includes(k) ||
          groupName(r.groupId).toLowerCase().includes(k)
        ));
      }

      listEl.innerHTML = arr.length ? arr.map(r => renderItem(r)).join("") : `<div class="mono">è¿™é‡Œè¿˜æ²¡æœ‰è®°å½•ï½ç‚¹â€œæ–°å¢â€å†™ä¸€æ¡å§ã€‚</div>`;
    };

    // store render function for modal scope
    modalScope.renderAll = render;
    modalScope.getAllState = () => ({filter, keyword});
    modalScope.setAllFilter = (v) => { filter = v; render(); };
    modalScope.setAllKeyword = (v) => { keyword = v; render(); };

    render();
  };

  const openGroups = () => {
    const html = `
      <div class="btnRow">
        <button class="btn primary" data-act="newGroup">æ–°å»ºåˆ†ç»„</button>
      </div>
      <div style="height:10px"></div>
      <div class="folderGrid" id="gGrid"></div>
      <div style="height:12px"></div>
      <div class="mono">ç‚¹åˆ†ç»„=æŸ¥çœ‹ï¼›ç‚¹â€œç¼–è¾‘â€å¯æ”¹åã€‚</div>
    `;
    openModal("ğŸ—‚ï¸ åˆ†ç»„ï¼ˆæ–‡ä»¶å¤¹ï¼‰", html);
    renderGroupsGrid();
  };

  const renderGroupsGrid = () => {
    const gGrid = $("#gGrid");
    if (!gGrid) return;
    gGrid.innerHTML = state.groups.map(g => {
      const count = state.records.filter(r=>r.groupId===g.id).length;
      return `
        <div class="folder" data-act="openGroup" data-gid="${g.id}">
          <b>${escapeHtml(g.name)}</b>
          <div class="small">ç‚¹å‡»æŸ¥çœ‹</div>
          <div class="count">${count} æ¡</div>
          <div class="btnRow" style="margin-top:8px">
            <button class="btn" data-act="renameGroup" data-gid="${g.id}">ç¼–è¾‘</button>
          </div>
        </div>
      `;
    }).join("");
  };

  const openGroupRecords = (gid) => {
    const gname = groupName(gid);
    const arr = state.records.filter(r=>r.groupId===gid);
    openModal(`ğŸ“ ${escapeHtml(gname)}`, `
      <div class="searchRow">
        <input id="gq" placeholder="åœ¨æ­¤åˆ†ç»„å†…æœç´¢â€¦" />
        <button class="btn" data-act="toggleFavOnly" data-gid="${gid}">â­ åªçœ‹æ”¶è—</button>
      </div>
      <div style="height:10px"></div>
      <div class="list" id="gList">
        ${arr.length ? arr.map(r=>renderItem(r)).join("") : `<div class="mono">è¿™ä¸ªåˆ†ç»„è¿˜ç©ºç€ï½</div>`}
      </div>
    `);

    modalScope.gid = gid;
    modalScope.onlyFav = false;
    modalScope.keyword = "";
    modalScope.renderGroup = () => {
      let arr2 = state.records.filter(r=>r.groupId===gid);
      if (modalScope.onlyFav) arr2 = arr2.filter(r=>r.fav);
      if (modalScope.keyword.trim()){
        const k = modalScope.keyword.trim().toLowerCase();
        arr2 = arr2.filter(r =>
          (r.title||"").toLowerCase().includes(k) ||
          (r.note||"").toLowerCase().includes(k) ||
          (r.source||"").toLowerCase().includes(k)
        );
      }
      const box = $("#gList");
      if (!box) return;
      box.innerHTML = arr2.length ? arr2.map(r=>renderItem(r)).join("") : `<div class="mono">æ²¡æœ‰åŒ¹é…çš„è®°å½•ï½</div>`;
    };
  };

  const openToday = () => {
    const d = fmtDate(now());
    const arr = state.records.filter(r => fmtDate(new Date(r.createdAt)) === d);
    openModal(`ğŸ—“ï¸ ä»Šå¤©ï¼ˆ${d}ï¼‰`, `
      <div class="btnRow">
        <button class="btn" data-act="genSummaryFromToday">ç”Ÿæˆä»Šæ—¥å°ç»“</button>
      </div>
      <div style="height:10px"></div>
      <div class="list" id="tList">${arr.length ? arr.map(r=>renderItem(r)).join("") : `<div class="mono">ä»Šå¤©è¿˜æ²¡è®°å½•ï½</div>`}</div>
    `);
  };

  // ---- Modal event delegation (key fix) ----
  const modalScope = {}; // store per-modal render functions/state
  const bindModalEvents = () => {
    const body = $("#modalBody");
    if (!body) return;

    // Tabs, buttons, items: use event delegation
    body.onclick = async (e) => {
      const el = e.target.closest("[data-act],[data-type],.tab");
      if (!el) return;

      // Type tabs in editor
      if (el.matches("[data-type]")) {
        const type = el.getAttribute("data-type");
        const scope = el.closest('[data-scope="editor"]');
        const id = scope?.getAttribute("data-id");
        const rec = id ? working.get(id) : null;
        if (!rec) return;
        rec.type = type;
        openEditModal(rec, scope?.getAttribute("data-new")==="1");
        return;
      }

      const act = el.getAttribute("data-act");
      const id = el.getAttribute("data-id");

      if (act === "edit") {
        const rec = findRecord(id);
        if (rec) openEditModal(JSON.parse(JSON.stringify(rec)), false);
        return;
      }

      if (act === "star") {
        const rec = findRecord(id);
        if (!rec) return;
        rec.fav = !rec.fav;
        upsertRecord(rec);
        // refresh current modal if it has a render
        if (modalScope.renderAll) modalScope.renderAll();
        if (modalScope.renderGroup) modalScope.renderGroup();
        // today list doesn't need extra, simplest re-open
        return;
      }

      if (act === "stats") {
        openModal("ğŸ“Š ç»Ÿè®¡é¢æ¿", renderStats());
        return;
      }

      if (act === "newGroup") {
        const name = await askText("æ–°å»ºåˆ†ç»„", "åˆ†ç»„åç§°", "æ–°åˆ†ç»„âœ¨");
        if (!name) return;
        state.groups.unshift({ id: uid(), name });
        saveState(state);
        renderHome();
        renderGroupsGrid();
        toast("å·²æ–°å»º");
        return;
      }

      if (act === "renameGroup") {
        const gid = el.getAttribute("data-gid");
        const g = state.groups.find(x=>x.id===gid);
        if (!g) return;
        const name = await askText("åˆ†ç»„æ”¹å", "è¾“å…¥æ–°çš„åˆ†ç»„åç§°", g.name);
        if (!name) return;
        g.name = name;
        saveState(state);
        renderHome();
        renderGroupsGrid();
        toast("å·²ä¿å­˜");
        return;
      }

      if (act === "openGroup") {
        const gid = el.getAttribute("data-gid");
        openGroupRecords(gid);
        return;
      }

      if (act === "toggleFavOnly") {
        modalScope.onlyFav = !modalScope.onlyFav;
        toast(modalScope.onlyFav ? "åªçœ‹æ”¶è—" : "æ˜¾ç¤ºå…¨éƒ¨");
        modalScope.renderGroup && modalScope.renderGroup();
        return;
      }

      if (act === "genSummaryFromToday") {
        $("#summaryBox").textContent = buildTodaySummary();
        toast("å·²ç”Ÿæˆ");
        closeModal();
        return;
      }

      // Editor actions
      if (act === "save") {
        const scope = el.closest('[data-scope="editor"]');
        const rid = scope?.getAttribute("data-id");
        const rec = rid ? working.get(rid) : null;
        if (!rec) { toast("ä¿å­˜å¤±è´¥"); return; }

        const before = JSON.parse(JSON.stringify(rec));

        const getVal = (sel) => (scope.querySelector(sel)?.value ?? "");
        const getNum = (sel) => Number(scope.querySelector(sel)?.value ?? 0);

        rec.groupId = getVal("#f_group") || rec.groupId;
        rec.title = String(getVal("#f_title")).trim();
        rec.source = String(getVal("#f_source")).trim();
        rec.note = String(getVal("#f_note")).trim();

        if (rec.type === "snack") rec.stars = Number(getVal("#f_stars") || 3);
        if (rec.type === "expense") rec.amount = getNum("#f_amount");
        if (rec.type === "study") rec.minutes = getNum("#f_minutes");

        // required
        if (!rec.title) { toast("æœ‰å¿…å¡«é¡¹æ²¡å†™"); return; }

        const patch = diffPatch(before, rec);
        if (Object.keys(patch).length) pushHistory(rec, patch);

        upsertRecord(rec);
        working.delete(rec.id);
        renderHome();
        toast("å·²ä¿å­˜");
        closeModal();
        return;
      }

      if (act === "history") {
        const rec = findRecord(id) || working.get(id);
        if (!rec) return;
        openModal("ğŸ•’ ç¼–è¾‘å†å²", renderHistory(rec));
        return;
      }

      if (act === "delete") {
        const ok = await askConfirm("ç¡®è®¤åˆ é™¤", "ç¡®å®šåˆ é™¤ï¼Ÿï¼ˆåˆ é™¤åä¸å¯æ¢å¤ï¼Œé™¤éä½ ä¹‹å‰å¯¼å‡ºå¤‡ä»½ï¼‰");
        if (!ok) return;
        deleteRecord(id);
        renderHome();
        toast("å·²åˆ é™¤");
        closeModal();
        return;
      }
    };

    // Inputs for list/group search (keyup)
    const q = $("#q");
    if (q) {
      q.oninput = (e) => {
        modalScope.setAllKeyword && modalScope.setAllKeyword(e.target.value || "");
      };
    }
    const gq = $("#gq");
    if (gq) {
      gq.oninput = (e) => {
        modalScope.keyword = e.target.value || "";
        modalScope.renderGroup && modalScope.renderGroup();
      };
    }

    // Tabs for list filter
    $$(".tab[data-filter]", body).forEach(t => {
      t.onclick = () => {
        $$(".tab[data-filter]", body).forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        modalScope.setAllFilter && modalScope.setAllFilter(t.getAttribute("data-filter"));
      };
    });

    // Editor toggles
    const favBtn = $("#f_fav");
    if (favBtn) {
      favBtn.onclick = () => {
        const scope = favBtn.closest('[data-scope="editor"]');
        const rid = scope?.getAttribute("data-id");
        const rec = rid ? working.get(rid) : null;
        if (!rec) return;
        rec.fav = !rec.fav;
        openEditModal(rec, !findRecord(rec.id));
      };
    }
    const doneBtn = $("#f_done");
    if (doneBtn) {
      doneBtn.onclick = () => {
        const scope = doneBtn.closest('[data-scope="editor"]');
        const rid = scope?.getAttribute("data-id");
        const rec = rid ? working.get(rid) : null;
        if (!rec) return;
        rec.done = !rec.done;
        openEditModal(rec, !findRecord(rec.id));
      };
    }

    // Editor type tabs bind (class based)
    $$(".tab[data-type]", body).forEach(b => {
      b.onclick = () => {
        const type = b.getAttribute("data-type");
        const scope = b.closest('[data-scope="editor"]');
        const rid = scope?.getAttribute("data-id");
        const rec = rid ? working.get(rid) : null;
        if (!rec) return;
        rec.type = type;
        openEditModal(rec, !findRecord(rec.id));
      };
    });
  };

  // ---- Home navigation buttons ----
  $("#btnAll").addEventListener("click", openAllRecords);
  $("#btnGroups").addEventListener("click", openGroups);
  $("#btnAdd").addEventListener("click", () => openAdd("snack"));
  $("#btnToday").addEventListener("click", openToday);

  // ---- Fix: list view render must be set after modal inject ----
  const openAllRecordsFixed = () => {
    openAllRecords();
    const render = () => {
      const listEl = $("#listBox");
      if (!listEl) return;

      const st = modalScope.getAllState ? modalScope.getAllState() : {filter:"all", keyword:""};
      let {filter, keyword} = st;

      let arr = [...state.records];
      if (filter === "fav") arr = arr.filter(r=>r.fav);
      else if (filter !== "all") arr = arr.filter(r=>r.type === filter);

      if (keyword.trim()){
        const k = keyword.trim().toLowerCase();
        arr = arr.filter(r => (
          (r.title||"").toLowerCase().includes(k) ||
          (r.note||"").toLowerCase().includes(k) ||
          (r.source||"").toLowerCase().includes(k) ||
          groupName(r.groupId).toLowerCase().includes(k)
        ));
      }

      listEl.innerHTML = arr.length ? arr.map(r => renderItem(r)).join("") : `<div class="mono">è¿™é‡Œè¿˜æ²¡æœ‰è®°å½•ï½ç‚¹â€œæ–°å¢â€å†™ä¸€æ¡å§ã€‚</div>`;
    };
    modalScope.renderAll = render;
    render();
  };

  // Override the button to use fixed render
  $("#btnAll").removeEventListener("click", openAllRecords);
  $("#btnAll").addEventListener("click", openAllRecordsFixed);

  // ---- Init ----
  initTheme();
  renderHome();

})();
</script>
</body>
</html>
