<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b12" />
  <title>å¿ƒç§‹å°ç”Ÿæ´»</title>

  <style>
    :root{
      /* base */
      --bg0:#07080d;
      --bg1:#0b0c12;

      --card:#0f111a;
      --card2:#141625;

      --line:rgba(255,255,255,.10);

      --text:#f2f3ff;
      --muted:rgba(242,243,255,.72);
      --muted2:rgba(242,243,255,.55);

      --shadow: 0 18px 50px rgba(0,0,0,.55);

      --accent1:#8b5cff;
      --accent2:#ff4db8;

      --ok:#7cffc9;
      --warn:#ffcd6b;
      --danger:#ff5a6a;

      --radius:22px;

      --tap: 52px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC","Hiragino Sans GB","Microsoft YaHei","Noto Sans CJK SC", Arial;
    }

    /* LIGHT THEME: ç”¨ä½ æçš„â€œæµ…ç´«æ¸å˜ + é»‘å­—â€ */
    [data-theme="light"]{
      --bg0:#f5f0ff;
      --bg1:#ffffff;

      --card:#ffffff;
      --card2:#f5f0ff;

      --line:rgba(20,25,38,.12);

      --text:#141926;
      --muted:rgba(20,25,38,.70);
      --muted2:rgba(20,25,38,.55);

      --shadow: 0 18px 60px rgba(24,28,45,.16);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      padding: 18px 14px calc(26px + env(safe-area-inset-bottom));
    }

    /* èƒŒæ™¯ï¼šæ·±è‰²æ·±ç´«æ¸å˜ / æµ…è‰²æµ…ç´«æ¸å˜ï¼ˆå¹¶é™ä½å…‰æ™•å¼ºåº¦é¿å…è‰²å¸¦ï¼‰ */
    body{
      background:
        radial-gradient(1100px 800px at 18% 12%, rgba(139,92,255,.18), transparent 58%),
        radial-gradient(1100px 800px at 88% 26%, rgba(255,77,184,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    [data-theme="light"] body{
      background:
        radial-gradient(1100px 800px at 18% 12%, rgba(139,92,255,.16), transparent 60%),
        radial-gradient(1100px 800px at 88% 26%, rgba(255,77,184,.10), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .wrap{max-width: 980px; margin:0 auto;}
    .top{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; margin-bottom:14px;
    }
    .title{
      display:flex; flex-direction:column; gap:6px;
      padding: 10px 10px;
    }
    .title h1{
      margin:0; font-size:28px; letter-spacing:.2px;
    }
    .sub{
      font-size:13px; color:var(--muted);
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.05);
    }
    [data-theme="light"] .pill{
      background: rgba(255,255,255,.85);
    }

    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .btn{
      height: var(--tap);
      padding: 0 14px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      font-weight:650;
      letter-spacing:.2px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    [data-theme="light"] .btn{
      background: rgba(255,255,255,.92);
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      box-shadow: 0 14px 40px rgba(139,92,255,.25);
      color:white;
    }
    .btn.ghost{ background: transparent; }
    [data-theme="light"] .btn.ghost{ background: rgba(255,255,255,.70); }
    .btn.danger{
      border:1px solid rgba(255,90,106,.35);
      background: rgba(255,90,106,.10);
      color: var(--text);
    }
    [data-theme="light"] .btn.danger{
      background: rgba(255,90,106,.12);
    }
    .btn.ok{
      border:1px solid rgba(124,255,201,.35);
      background: rgba(124,255,201,.10);
    }
    [data-theme="light"] .btn.ok{ background: rgba(124,255,201,.14); }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* å¡ç‰‡ï¼šæµ…è‰²æ›´â€œå®â€ï¼Œæ·±è‰²ä¿ç•™ä¸€ç‚¹æ°›å›´ */
    .card{
      background: rgba(255,255,255,.045);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    [data-theme="light"] .card{
      background: rgba(255,255,255,.92);
    }

    .cardHeader{
      padding:16px 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .cardHeader .h{
      display:flex; flex-direction:column; gap:4px;
    }
    .cardHeader .h b{ font-size:15px; letter-spacing:.2px; }
    .cardHeader .h span{ font-size:12px; color:var(--muted); }
    .cardBody{ padding: 12px 16px 16px; }

    .modules{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .module{
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.035);
      padding: 14px 14px;
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease;
    }
    [data-theme="light"] .module{
      background: rgba(245,240,255,.85);
    }
    .module:active{ transform: scale(.99); }
    .module .left{display:flex; gap:10px; align-items:flex-start}
    .icon{
      width:38px; height:38px; border-radius: 14px;
      display:grid; place-items:center;
      background: rgba(139,92,255,.14);
      border:1px solid rgba(139,92,255,.22);
      font-size:18px;
      flex:none;
    }
    [data-theme="light"] .icon{
      background: rgba(139,92,255,.16);
    }
    .module .meta{display:flex; flex-direction:column; gap:6px}
    .module .meta b{ font-size:15px; }
    .module .meta span{ font-size:12px; color:var(--muted); line-height:1.35}
    .module .count{
      font-size:24px; font-weight:800; opacity:.9;
      margin-left:10px;
    }

    .rightCard .cardBody{
      display:flex; flex-direction:column; gap:12px;
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .kpi{
      flex:1; min-width: 150px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 12px 12px;
    }
    [data-theme="light"] .kpi{
      background: rgba(245,240,255,.85);
    }
    .kpi b{ display:block; font-size:12px; color:var(--muted); margin-bottom:8px; }
    .kpi span{ font-size:18px; font-weight:800; }

    .list{display:flex; flex-direction:column; gap:10px;}
    .item{
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 12px 12px;
      display:flex; justify-content:space-between; gap:10px;
      align-items:flex-start;
    }
    [data-theme="light"] .item{
      background: rgba(245,240,255,.85);
    }
    .item .a{display:flex; flex-direction:column; gap:6px}
    .item .a b{font-size:14px}
    .item .a small{font-size:12px; color:var(--muted); line-height:1.35}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,.03);
      white-space:nowrap;
    }
    [data-theme="light"] .tag{
      background: rgba(255,255,255,.92);
    }

    /* ---- Inputs ---- */
    .field{display:flex; flex-direction:column; gap:8px;}
    label{ font-size:12px; color:var(--muted); }
    input, select, textarea{
      width:100%;
      font: inherit;
      color: var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      outline:none;
      transition: border-color .2s ease, background .2s ease, box-shadow .2s ease;
    }
    [data-theme="light"] input,
    [data-theme="light"] select,
    [data-theme="light"] textarea{
      background: rgba(255,255,255,.92);
      color: var(--text);
    }
    textarea{ min-height: 86px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(139,92,255,.55);
      box-shadow: 0 0 0 4px rgba(139,92,255,.18);
      background: rgba(255,255,255,.08);
    }
    [data-theme="light"] input:focus,
    [data-theme="light"] select:focus,
    [data-theme="light"] textarea:focus{
      background: #fff;
    }
    .req{ color: var(--warn); font-weight:800; margin-left:4px; }

    .footerBar{
      position: sticky;
      bottom: 0;
      margin-top: 14px;
      display:flex; gap:10px;
      padding: 10px 0 0;
    }
    .footerBar .btn{ flex:1; height: 56px; border-radius: 18px; }
    .footerBar .btn.primary{ flex: 1.2; }

    /* ---- Modal (å…³é”®ä¿®å¤ï¼šå¯æ»šåŠ¨ + æ‰‹æœºé¡ºæ»‘) ---- */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 9999;
      padding: 18px 14px calc(18px + env(safe-area-inset-bottom));
    }
    [data-theme="light"] .overlay{
      background: rgba(20,25,38,.30);
    }
    .overlay.show{ display:block; }

    .modal{
      max-width: 780px;
      margin: 0 auto;
      border-radius: 26px;
      border:1px solid var(--line);
      overflow:hidden;

      /* ä¿®å¤ï¼šæ•´ä½“é«˜åº¦é™åˆ¶ */
      max-height: 92vh;
      display:flex;
      flex-direction:column;

      /* è®©å±‚æ¬¡æ›´å¹²å‡€ï¼Œå‡å°‘è‰²å¸¦ */
      background: linear-gradient(180deg, rgba(20,22,35,.92), rgba(12,13,20,.92));
      box-shadow: 0 30px 90px rgba(0,0,0,.60);
    }
    [data-theme="light"] .modal{
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(245,240,255,.96));
      box-shadow: 0 30px 90px rgba(24,28,45,.26);
    }

    .modalHead{
      padding: 16px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid var(--line);
      flex: none;
    }
    .modalHead b{ font-size:15px; }
    .modalHead .right{ display:flex; gap:10px; align-items:center; }

    /* ä¿®å¤ï¼šmodalBody å¯æ»šåŠ¨ */
    .modalBody{
      padding: 14px 16px 16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    .hint{
      font-size:12px; color:var(--muted2); line-height:1.4;
      border-left: 3px solid rgba(139,92,255,.55);
      padding: 8px 10px;
      background: rgba(139,92,255,.08);
      border-radius: 12px;
    }
    [data-theme="light"] .hint{
      background: rgba(139,92,255,.10);
    }

    .miniRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .miniRow .btn{ height: 44px; padding: 0 12px; border-radius: 14px; font-weight:700; }

    .divider{ height:1px; background: var(--line); margin: 6px 0; }

    .search{ display:flex; gap:10px; align-items:center; }
    .search input{ flex:1; }

    .empty{
      padding: 18px 12px;
      text-align:center;
      color: var(--muted);
      border:1px dashed var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,.02);
    }
    [data-theme="light"] .empty{ background: rgba(255,255,255,.9); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.7);
      color: white;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      display:none;
      z-index: 10000;
      font-size: 13px;
    }
    [data-theme="light"] .toast{ background: rgba(20,25,38,.78); }
    .toast.show{ display:block; }

    a{ color: inherit; text-decoration: none; }
  </style>
</head>

<body>
  <div class="wrap" id="app" data-theme="dark">
    <div class="top">
      <div class="title">
        <h1>å¿ƒç§‹å°ç”Ÿæ´»</h1>
        <div class="sub">
          <span class="pill">ğŸ•’ ç°åœ¨ï¼š<span id="nowText"></span></span>
          <span class="pill">ğŸ“Œ æœ¬åœ°ä¿å­˜ Â· å¸¦ç¼–è¾‘å†å²</span>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="themeBtn">ä¸»é¢˜ï¼šæ·±è‰²</button>
        <button class="btn" id="exportBtn">å¯¼å‡ºå¤‡ä»½</button>
        <button class="btn" id="importBtn">å¯¼å…¥å¤‡ä»½</button>
        <button class="btn danger" id="wipeBtn">æ¸…ç©ºæ•°æ®</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div class="h">
            <b>ä¸»é¡µ</b>
            <span>åƒä¾¿ç­¾ä¸€æ ·ï¼šå¿«è®°ã€å¯åˆ†ç»„ã€å¯æ”¶è—ã€å¯ç»Ÿè®¡ã€‚</span>
          </div>
          <div class="row">
            <button class="btn" id="allBtn">ğŸ“š å…¨éƒ¨è®°å½•</button>
            <button class="btn" id="groupsBtn">ğŸ“ åˆ†ç»„</button>
          </div>
        </div>

        <div class="cardBody">
          <div class="modules" id="modules"></div>
          <div class="footerBar">
            <button class="btn primary" id="addBtn">æ–°å¢</button>
            <button class="btn" id="todayBtn">ä»Šå¤©</button>
          </div>
        </div>
      </div>

      <div class="card rightCard">
        <div class="cardHeader">
          <div class="h">
            <b>å°æ€»ç»“</b>
            <span>ç»™ä½ ä¸€ä¸ªâ€œè¶Šè®°è¶Šçˆ½â€çš„åŠ¨åŠ›ã€‚</span>
          </div>
          <button class="btn ok" id="summaryBtn">âœ¨ ç”Ÿæˆå°æ€»ç»“</button>
        </div>

        <div class="cardBody">
          <div class="row">
            <div class="kpi"><b>æ€»è®°å½•</b><span id="kpiTotal">0</span></div>
            <div class="kpi"><b>æ”¶è—</b><span id="kpiFav">0</span></div>
          </div>
          <div class="row">
            <div class="kpi"><b>é›¶é£Ÿå¹³å‡æ˜Ÿçº§</b><span id="kpiSnackAvg">-</span></div>
            <div class="kpi"><b>æœ€è¿‘ä¸€æ¬¡è®°å½•</b><span id="kpiLast">-</span></div>
          </div>

          <div class="divider"></div>

          <div class="hint" id="hintBox">
            å°ç©æ³•ï¼šä½ æ¯æ¬¡è®°å®Œé›¶é£Ÿï¼Œç‚¹ä¸€ä¸‹â€œæ”¶è—â­â€ï¼Œä»¥åä¹°é›¶é£Ÿå°±èƒ½ç›´æ¥ç¿»ä½ çš„â€œé«˜åˆ†æ¸…å•â€ã€‚
          </div>

          <div class="list" id="recentList"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <b id="modalTitle">æ–°å¢</b>
        <div class="right">
          <button class="btn ghost" id="closeModalBtn">âœ• å…³é—­</button>
        </div>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <input id="filePicker" type="file" accept="application/json" style="display:none" />

  <script>
    const $ = (s, el=document)=> el.querySelector(s);
    const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
    const uid = ()=> Math.random().toString(16).slice(2)+Date.now().toString(16);
    const fmtTime = (ts)=>{
      const d = new Date(ts);
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };
    const toast = (msg)=>{
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.classList.remove("show"), 1700);
    };

    const STORAGE_KEY = "xq_life_data_v2";
    const defaultData = {
      version: 2,
      theme: "dark",
      groups: ["é»˜è®¤ğŸ“Œ","åƒåƒåƒğŸ˜‹","å­¦ä¹ ğŸ“š","ç”Ÿæ´»ğŸŒ™","ä»£åŠâœ…"],
      records: []
    };

    function loadData(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return structuredClone(defaultData);
        const data = JSON.parse(raw);
        if(!data.version) data.version = 1;
        if(!data.groups) data.groups = structuredClone(defaultData.groups);
        if(!Array.isArray(data.records)) data.records = [];
        if(!data.theme) data.theme = "dark";
        data.records.forEach(r=>{
          r.history = Array.isArray(r.history) ? r.history : [];
          r.fav = !!r.fav;
        });
        return data;
      }catch(e){
        return structuredClone(defaultData);
      }
    }
    function saveData(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      renderAll();
    }

    let state = loadData();

    const MODULES = [
      { type:"snack", name:"é›¶é£Ÿè¯„åˆ†", icon:"ğŸª", desc:"è®°å½•é›¶é£Ÿã€æ¸ é“ã€æ˜Ÿçº§ã€å¤‡æ³¨ï¼›æ”¯æŒæ”¶è—â­ã€‚"},
      { type:"money", name:"è®°è´¦", icon:"ğŸ’°", desc:"å¿«é€Ÿè®°ä¸€ç¬”é’±ï¼šé‡‘é¢+åˆ†ç±»/æ¥æº+å¤‡æ³¨ã€‚"},
      { type:"study", name:"å­¦ä¹ æ‰“å¡", icon:"ğŸ“š", desc:"è®°å½•å­¦ä¹ å†…å®¹å’Œç”¨æ—¶ï¼Œå¤ç›˜æ›´æ¸…æ¥šã€‚"},
      { type:"todo",  name:"ä»£åŠæ¸…å•", icon:"âœ…", desc:"ç®€å•ä»£åŠï¼šå¯å®Œæˆã€å¯å½’æ¡£ã€‚"},
      { type:"life",  name:"ç”Ÿæ´»è®°å½•", icon:"ğŸŒ™", desc:"ä¸€å¥è¯éšæ‰‹è®°ï¼šå¿ƒæƒ…/çµæ„Ÿ/æ—¥å¸¸ã€‚"}
    ];

    let currentType = "snack";

    function setTheme(theme){
      state.theme = theme;
      $("#app").setAttribute("data-theme", theme);
      $("#themeBtn").textContent = `ä¸»é¢˜ï¼š${theme==="dark" ? "æ·±è‰²" : "æµ…è‰²"}`;
      // è®©æµè§ˆå™¨åœ°å€æ é…è‰²è·Ÿç€å˜ï¼ˆå¯é€‰ä½†çœ‹ç€èˆ’æœï¼‰
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta) meta.setAttribute("content", theme==="dark" ? "#0b0b12" : "#f5f0ff");
      saveData();
    }

    function tickNow(){
      $("#nowText").textContent = fmtTime(Date.now());
    }

    function countByType(type){ return state.records.filter(r=> r.type===type).length; }
    function favCount(){ return state.records.filter(r=> r.fav).length; }

    function snackAvg(){
      const a = state.records.filter(r=> r.type==="snack" && typeof r.rating==="number");
      if(!a.length) return "-";
      const s = a.reduce((sum,r)=> sum + r.rating, 0);
      return (s / a.length).toFixed(1) + "â­";
    }

    function lastTime(){
      if(!state.records.length) return "-";
      const r = [...state.records].sort((a,b)=> (b.updatedAt||b.createdAt)-(a.updatedAt||a.createdAt))[0];
      return fmtTime(r.updatedAt||r.createdAt);
    }

    function renderModules(){
      const box = $("#modules");
      box.innerHTML = "";
      MODULES.forEach(m=>{
        const el = document.createElement("div");
        el.className = "module";
        el.innerHTML = `
          <div class="left">
            <div class="icon">${m.icon}</div>
            <div class="meta">
              <b>${m.name}</b>
              <span>${m.desc}</span>
            </div>
          </div>
          <div class="count">${countByType(m.type)}</div>
        `;
        el.onclick = ()=>{
          currentType = m.type;
          openAddModal(m.type);
        };
        box.appendChild(el);
      });
    }

    function renderKPIs(){
      $("#kpiTotal").textContent = state.records.length;
      $("#kpiFav").textContent = favCount();
      $("#kpiSnackAvg").textContent = snackAvg();
      $("#kpiLast").textContent = lastTime();
    }

    function renderRecent(){
      const list = $("#recentList");
      const recent = [...state.records].sort((a,b)=> (b.updatedAt||b.createdAt)-(a.updatedAt||a.createdAt)).slice(0,5);
      list.innerHTML = "";
      if(!recent.length){
        list.innerHTML = `<div class="empty">è¿˜æ²¡æœ‰è®°å½•ã€‚ç‚¹å·¦ä¸‹â€œæ–°å¢â€å°±èƒ½å¼€å†™å•¦ï½</div>`;
        return;
      }
      recent.forEach(r=>{
        const line = r.type==="snack"
          ? `${r.rating ? r.rating+"â­" : ""} ${r.source? "Â· "+r.source : ""}`
          : r.type==="money"
            ? `${typeof r.amount==="number" ? "Â¥"+r.amount : ""} ${r.source? "Â· "+r.source : ""}`
            : (r.source? r.source:"");
        const title = r.title || "(æœªå‘½å)";
        const tag = r.group || "é»˜è®¤ğŸ“Œ";
        const icon = MODULES.find(m=>m.type===r.type)?.icon || "ğŸ“";
        const time = fmtTime(r.updatedAt||r.createdAt);
        list.insertAdjacentHTML("beforeend", `
          <div class="item">
            <div class="a">
              <b>${icon} ${escapeHtml(title)} ${r.fav ? "â­":""}</b>
              <small>${escapeHtml(tag)} Â· ${escapeHtml(line)} Â· ${time}</small>
            </div>
            <span class="tag" role="button" data-id="${r.id}">ç¼–è¾‘</span>
          </div>
        `);
      });

      $$(".tag", list).forEach(t=>{
        t.onclick = ()=>{
          const id = t.getAttribute("data-id");
          const rec = state.records.find(x=>x.id===id);
          if(rec) openEditModal(rec);
        };
      });
    }

    function renderAll(){
      renderModules();
      renderKPIs();
      renderRecent();
    }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      })[m]);
    }

    function openModal(title, bodyHtml){
      $("#modalTitle").textContent = title;
      $("#modalBody").innerHTML = bodyHtml;
      $("#overlay").classList.add("show");
      $("#overlay").setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }
    function closeModal(){
      $("#overlay").classList.remove("show");
      $("#overlay").setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }

    $("#closeModalBtn").onclick = closeModal;
    $("#overlay").addEventListener("click",(e)=>{
      if(e.target.id==="overlay") closeModal();
    });

    function groupOptions(selected){
      return state.groups.map(g=> `<option ${g===selected?"selected":""} value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("");
    }

    function quickTemplates(type){
      if(type!=="snack" && type!=="money") return "";
      if(type==="snack"){
        return `
          <div class="miniRow">
            <button class="btn" data-tpl="é›¶é£Ÿæœ‰é¸£">é›¶é£Ÿæœ‰é¸£</button>
            <button class="btn" data-tpl="ç½‘è´­">ç½‘è´­</button>
            <button class="btn" data-tpl="è¶…å¸‚">è¶…å¸‚</button>
            <button class="btn" data-tpl="ä¾¿åˆ©åº—">ä¾¿åˆ©åº—</button>
          </div>
        `;
      }
      return `
        <div class="miniRow">
          <button class="btn" data-tpl="åƒé¥­">åƒé¥­</button>
          <button class="btn" data-tpl="é€šå‹¤">é€šå‹¤</button>
          <button class="btn" data-tpl="çŒ«å’ª">çŒ«å’ª</button>
          <button class="btn" data-tpl="å­¦ä¹ ">å­¦ä¹ </button>
        </div>
      `;
    }

    function openAddModal(type){
      currentType = type;

      const commonTop = `
        <div class="hint">å°æŠ€å·§ï¼šä½ å¯ä»¥å…ˆé€‰åˆ†ç»„ï¼›å¸¸ç”¨æ¥æºå¯ä»¥ç‚¹ä¸‹é¢â€œå¿«é€Ÿæ¨¡æ¿â€ä¸€é”®å¡«ã€‚</div>
        <div class="field">
          <label>åˆ†ç»„</label>
          <select id="f_group">${groupOptions("é»˜è®¤ğŸ“Œ")}</select>
        </div>
      `;

      let form = "";
      if(type==="snack"){
        form = `
          ${commonTop}
          ${quickTemplates("snack")}
          <div class="field">
            <label>é›¶é£Ÿåç§°<span class="req">*</span></label>
            <input id="f_title" placeholder="ä¾‹å¦‚ï¼šæµ·è‹”è‚‰æ¾å°è´" />
          </div>
          <div class="field">
            <label>åº—é“º/æ¥æº</label>
            <input id="f_source" placeholder="ä¾‹å¦‚ï¼šé›¶é£Ÿæœ‰é¸£ / ç½‘è´­ / è¶…å¸‚" />
          </div>
          <div class="field">
            <label>å–œçˆ±ç¨‹åº¦ï¼ˆ1-5â­ï¼‰<span class="req">*</span></label>
            <select id="f_rating">
              <option value="5">5â­</option>
              <option value="4">4â­</option>
              <option value="3" selected>3â­</option>
              <option value="2">2â­</option>
              <option value="1">1â­</option>
            </select>
          </div>
          <div class="field">
            <label>å¤‡æ³¨</label>
            <textarea id="f_notes" placeholder="å£æ„Ÿ/ç”œåº¦/å›è´­ï¼Ÿ"></textarea>
          </div>
          <div class="miniRow">
            <button class="btn" id="f_favBtn">â˜† ç‚¹æˆ‘æ”¶è—</button>
          </div>
          <div class="footerBar">
            <button class="btn primary" id="saveNew">ä¿å­˜</button>
            <button class="btn" id="cancelNew">å–æ¶ˆ</button>
          </div>
        `;
      }else if(type==="money"){
        form = `
          ${commonTop}
          ${quickTemplates("money")}
          <div class="field">
            <label>æ ‡é¢˜<span class="req">*</span></label>
            <input id="f_title" placeholder="ä¾‹å¦‚ï¼šéº»è¾£çƒ« / è½¦è´¹ / çŒ«ç²®" />
          </div>
          <div class="field">
            <label>é‡‘é¢ï¼ˆå…ƒï¼‰<span class="req">*</span></label>
            <input id="f_amount" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š18.5" />
          </div>
          <div class="field">
            <label>åˆ†ç±»/æ¥æº</label>
            <input id="f_source" placeholder="ä¾‹å¦‚ï¼šåƒé¥­ / é€šå‹¤ / çŒ«å’ª / å­¦ä¹ " />
          </div>
          <div class="field">
            <label>å¤‡æ³¨</label>
            <textarea id="f_notes" placeholder="ç”¨äº†åˆ¸ï¼Ÿå¿ƒæƒ…ï¼Ÿ"></textarea>
          </div>
          <div class="miniRow">
            <button class="btn" id="f_favBtn">â˜† ç‚¹æˆ‘æ”¶è—</button>
          </div>
          <div class="footerBar">
            <button class="btn primary" id="saveNew">ä¿å­˜</button>
            <button class="btn" id="cancelNew">å–æ¶ˆ</button>
          </div>
        `;
      }else if(type==="study"){
        form = `
          ${commonTop}
          <div class="field">
            <label>å­¦ä¹ å†…å®¹<span class="req">*</span></label>
            <input id="f_title" placeholder="ä¾‹å¦‚ï¼šæ”¿æ²»â€”ç»æµç”Ÿæ´»ç¬¬ä¸‰ç« " />
          </div>
          <div class="field">
            <label>ç”¨æ—¶ï¼ˆåˆ†é’Ÿï¼‰</label>
            <input id="f_amount" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š45" />
          </div>
          <div class="field">
            <label>å¤‡æ³¨</label>
            <textarea id="f_notes" placeholder="é”™é¢˜/æ”¶è·/æ˜å¤©è®¡åˆ’"></textarea>
          </div>
          <div class="miniRow">
            <button class="btn" id="f_favBtn">â˜† ç‚¹æˆ‘æ”¶è—</button>
          </div>
          <div class="footerBar">
            <button class="btn primary" id="saveNew">ä¿å­˜</button>
            <button class="btn" id="cancelNew">å–æ¶ˆ</button>
          </div>
        `;
      }else if(type==="todo"){
        form = `
          ${commonTop}
          <div class="field">
            <label>å¾…åŠæ ‡é¢˜<span class="req">*</span></label>
            <input id="f_title" placeholder="ä¾‹å¦‚ï¼šå¸¦æ¢¨èŠ±å»æ‰“ç–«è‹—" />
          </div>
          <div class="field">
            <label>å¤‡æ³¨</label>
            <textarea id="f_notes" placeholder="æ—¶é—´/åœ°ç‚¹/æ³¨æ„äº‹é¡¹"></textarea>
          </div>
          <div class="footerBar">
            <button class="btn primary" id="saveNew">ä¿å­˜</button>
            <button class="btn" id="cancelNew">å–æ¶ˆ</button>
          </div>
        `;
      }else{
        form = `
          ${commonTop}
          <div class="field">
            <label>æ ‡é¢˜<span class="req">*</span></label>
            <input id="f_title" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©çš„å¤©ç©ºå¥½å¥½çœ‹" />
          </div>
          <div class="field">
            <label>å†…å®¹</label>
            <textarea id="f_notes" placeholder="éšæ‰‹è®°ä¸¤å¥"></textarea>
          </div>
          <div class="miniRow">
            <button class="btn" id="f_favBtn">â˜† ç‚¹æˆ‘æ”¶è—</button>
          </div>
          <div class="footerBar">
            <button class="btn primary" id="saveNew">ä¿å­˜</button>
            <button class="btn" id="cancelNew">å–æ¶ˆ</button>
          </div>
        `;
      }

      openModal(`æ–°å¢ Â· ${MODULES.find(m=>m.type===type)?.name || "è®°å½•"}`, form);

      let fav = false;
      const favBtn = $("#f_favBtn");
      if(favBtn){
        favBtn.onclick = ()=>{
          fav = !fav;
          favBtn.textContent = fav ? "â˜… å·²æ”¶è—" : "â˜† ç‚¹æˆ‘æ”¶è—";
        };
      }

      $$(".miniRow .btn", $("#modalBody")).forEach(b=>{
        const tpl = b.getAttribute("data-tpl");
        if(!tpl) return;
        b.onclick = ()=>{
          const source = $("#f_source");
          if(source){
            source.value = tpl;
            toast("å·²å¡«å…¥ï¼š" + tpl);
          }
        };
      });

      $("#cancelNew").onclick = closeModal;
      $("#saveNew").onclick = ()=>{
        const group = ($("#f_group")?.value || "é»˜è®¤ğŸ“Œ").trim();
        const title = ($("#f_title")?.value || "").trim();
        const source = ($("#f_source")?.value || "").trim();
        const notes = ($("#f_notes")?.value || "").trim();
        const rating = $("#f_rating") ? Number($("#f_rating").value) : undefined;

        let amount;
        if($("#f_amount")){
          const v = ($("#f_amount").value || "").trim();
          amount = v ? Number(v) : undefined;
          if(v && Number.isNaN(amount)){
            toast("é‡‘é¢/åˆ†é’Ÿå†™æˆæ•°å­—å“¦ï½");
            return;
          }
        }

        if(!title){
          toast("æ ‡é¢˜/åç§°æ˜¯å¿…å¡«ï½");
          return;
        }

        const now = Date.now();
        const rec = {
          id: uid(),
          type,
          group,
          title,
          source,
          rating: type==="snack" ? rating : undefined,
          amount: (type==="money"||type==="study") ? amount : undefined,
          notes,
          fav: !!fav,
          createdAt: now,
          updatedAt: now,
          history: [{
            at: now,
            action: "create",
            snapshot: { group, title, source, rating, amount, notes, fav }
          }]
        };

        state.records.push(rec);
        saveData();
        closeModal();
        toast("ä¿å­˜æˆåŠŸâœ…");
      };
    }

    function openEditModal(rec){
      const typeName = MODULES.find(m=>m.type===rec.type)?.name || "è®°å½•";
      const isSnack = rec.type==="snack";
      const isMoney = rec.type==="money";
      const isStudy = rec.type==="study";
      const hasAmount = isMoney || isStudy;

      openModal(`ç¼–è¾‘ Â· ${typeName}`, `
        <div class="hint">ä½ å¯ä»¥æ”¹å†…å®¹ï¼›æ¯æ¬¡ä¿å­˜éƒ½ä¼šå†™å…¥â€œç¼–è¾‘å†å²â€ã€‚ï¼ˆæœ¬åœ°ä¿å­˜ï¼‰</div>

        <div class="field">
          <label>åˆ†ç»„</label>
          <select id="e_group">${groupOptions(rec.group||"é»˜è®¤ğŸ“Œ")}</select>
        </div>

        <div class="field">
          <label>${isSnack ? "é›¶é£Ÿåç§°" : "æ ‡é¢˜"}<span class="req">*</span></label>
          <input id="e_title" value="${escapeHtml(rec.title)}" />
        </div>

        ${isSnack || isMoney ? `
          ${quickTemplates(isSnack ? "snack" : "money")}
          <div class="field">
            <label>${isSnack ? "åº—é“º/æ¥æº" : "åˆ†ç±»/æ¥æº"}</label>
            <input id="e_source" value="${escapeHtml(rec.source||"")}" />
          </div>
        ` : ""}

        ${isSnack ? `
          <div class="field">
            <label>å–œçˆ±ç¨‹åº¦ï¼ˆ1-5â­ï¼‰<span class="req">*</span></label>
            <select id="e_rating">
              ${[5,4,3,2,1].map(n=>`<option value="${n}" ${Number(rec.rating||3)===n?"selected":""}>${n}â­</option>`).join("")}
            </select>
          </div>
        ` : ""}

        ${hasAmount ? `
          <div class="field">
            <label>${isMoney ? "é‡‘é¢ï¼ˆå…ƒï¼‰" : "ç”¨æ—¶ï¼ˆåˆ†é’Ÿï¼‰"}</label>
            <input id="e_amount" inputmode="decimal" value="${typeof rec.amount==="number" ? rec.amount : ""}" />
          </div>
        ` : ""}

        <div class="field">
          <label>å¤‡æ³¨</label>
          <textarea id="e_notes">${escapeHtml(rec.notes||"")}</textarea>
        </div>

        <div class="miniRow">
          <button class="btn" id="e_favBtn">${rec.fav ? "â˜… å·²æ”¶è—" : "â˜† ç‚¹æˆ‘æ”¶è—"}</button>
          <button class="btn danger" id="e_delBtn">ğŸ—‘ åˆ é™¤</button>
        </div>

        <div class="footerBar">
          <button class="btn primary" id="e_saveBtn">ä¿å­˜ä¿®æ”¹</button>
          <button class="btn" id="e_closeBtn">å…³é—­</button>
        </div>
      `);

      $$(".miniRow .btn", $("#modalBody")).forEach(b=>{
        const tpl = b.getAttribute("data-tpl");
        if(!tpl) return;
        b.onclick = ()=>{
          const source = $("#e_source");
          if(source){
            source.value = tpl;
            toast("å·²å¡«å…¥ï¼š" + tpl);
          }
        };
      });

      let fav = !!rec.fav;
      $("#e_favBtn").onclick = ()=>{
        fav = !fav;
        $("#e_favBtn").textContent = fav ? "â˜… å·²æ”¶è—" : "â˜† ç‚¹æˆ‘æ”¶è—";
      };

      $("#e_closeBtn").onclick = closeModal;

      $("#e_delBtn").onclick = ()=>{
        if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ï¼ˆé™¤éä½ æœ‰å¤‡ä»½ï¼‰ã€‚")) return;
        state.records = state.records.filter(x=>x.id!==rec.id);
        saveData();
        closeModal();
        toast("å·²åˆ é™¤");
      };

      $("#e_saveBtn").onclick = ()=>{
        const group = ($("#e_group")?.value || "é»˜è®¤ğŸ“Œ").trim();
        const title = ($("#e_title")?.value || "").trim();
        const source = ($("#e_source")?.value || "").trim();
        const notes = ($("#e_notes")?.value || "").trim();

        if(!title){
          toast("æ ‡é¢˜/åç§°æ˜¯å¿…å¡«ï½");
          return;
        }

        let rating;
        if($("#e_rating")) rating = Number($("#e_rating").value);

        let amount;
        if($("#e_amount")){
          const v = ($("#e_amount").value || "").trim();
          amount = v ? Number(v) : undefined;
          if(v && Number.isNaN(amount)){
            toast("é‡‘é¢/åˆ†é’Ÿå†™æˆæ•°å­—å“¦ï½");
            return;
          }
        }

        const now = Date.now();
        rec.group = group;
        rec.title = title;
        rec.source = source;
        rec.notes = notes;
        rec.fav = fav;
        if(rec.type==="snack") rec.rating = rating;
        if(rec.type==="money" || rec.type==="study") rec.amount = amount;

        rec.updatedAt = now;
        rec.history = rec.history || [];
        rec.history.push({
          at: now,
          action: "update",
          snapshot: { group, title, source, rating, amount, notes, fav }
        });

        saveData();
        closeModal();
        toast("å·²ä¿å­˜âœ…");
      };
    }

    function openAllRecords(){
      openModal("å…¨éƒ¨è®°å½•", `
        <div class="search">
          <input id="q" placeholder="æœç´¢ï¼šæ ‡é¢˜ / æ¥æº / å¤‡æ³¨ / åˆ†ç»„" />
          <button class="btn" id="qFav">åªçœ‹æ”¶è—â­</button>
        </div>
        <div class="divider"></div>
        <div id="allList" class="list"></div>
      `);

      let onlyFav = false;

      $("#qFav").onclick = ()=>{
        onlyFav = !onlyFav;
        $("#qFav").textContent = onlyFav ? "æ”¶è—â­ï¼ˆå¼€ï¼‰" : "åªçœ‹æ”¶è—â­";
        draw();
      };

      $("#q").addEventListener("input", draw);

      function draw(){
        const kw = ($("#q").value||"").trim().toLowerCase();
        let arr = [...state.records].sort((a,b)=> (b.updatedAt||b.createdAt)-(a.updatedAt||a.createdAt));
        if(onlyFav) arr = arr.filter(r=> r.fav);
        if(kw){
          arr = arr.filter(r=>{
            const blob = `${r.title||""} ${r.source||""} ${r.notes||""} ${r.group||""}`.toLowerCase();
            return blob.includes(kw);
          });
        }

        const box = $("#allList");
        box.innerHTML = "";
        if(!arr.length){
          box.innerHTML = `<div class="empty">æ²¡æœ‰åŒ¹é…çš„è®°å½•ã€‚</div>`;
          return;
        }
        arr.forEach(r=>{
          const icon = MODULES.find(m=>m.type===r.type)?.icon || "ğŸ“";
          const time = fmtTime(r.updatedAt||r.createdAt);
          box.insertAdjacentHTML("beforeend", `
            <div class="item">
              <div class="a">
                <b>${icon} ${escapeHtml(r.title)} ${r.fav?"â­":""}</b>
                <small>${escapeHtml(r.group||"é»˜è®¤ğŸ“Œ")} Â· ${time}</small>
              </div>
              <span class="tag" role="button" data-id="${r.id}">ç¼–è¾‘</span>
            </div>
          `);
        });
        $$(".tag", box).forEach(t=>{
          t.onclick = ()=>{
            const id = t.getAttribute("data-id");
            const rec = state.records.find(x=>x.id===id);
            if(rec) openEditModal(rec);
          };
        });
      }
      draw();
    }

    function openGroups(){
      openModal("åˆ†ç»„ç®¡ç†", `
        <div class="hint">ä½ å¯ä»¥è‡ªç”±æ–°å¢åˆ†ç»„ï¼›è®°å½•çš„â€œåˆ†ç»„â€ä¸‹æ‹‰ä¼šè‡ªåŠ¨åŒæ­¥ã€‚</div>
        <div class="field">
          <label>æ–°å¢åˆ†ç»„</label>
          <input id="g_new" placeholder="ä¾‹å¦‚ï¼šåƒåƒåƒğŸ˜‹ / å­¦ä¹ ğŸ“š / ç”Ÿæ´»ğŸŒ™" />
        </div>
        <div class="miniRow">
          <button class="btn primary" id="g_add">æ·»åŠ </button>
          <button class="btn" id="g_reset">æ¢å¤é»˜è®¤åˆ†ç»„</button>
        </div>
        <div class="divider"></div>
        <div class="list" id="g_list"></div>
      `);

      function draw(){
        const box = $("#g_list");
        box.innerHTML = "";
        state.groups.forEach((g,idx)=>{
          const count = state.records.filter(r=> (r.group||"é»˜è®¤ğŸ“Œ")===g).length;
          box.insertAdjacentHTML("beforeend", `
            <div class="item">
              <div class="a">
                <b>${escapeHtml(g)}</b>
                <small>${count} æ¡è®°å½•</small>
              </div>
              <span class="tag" role="button" data-idx="${idx}">åˆ é™¤</span>
            </div>
          `);
        });

        $$(".tag", box).forEach(t=>{
          t.onclick = ()=>{
            const i = Number(t.getAttribute("data-idx"));
            const g = state.groups[i];
            if(!g) return;
            if(g==="é»˜è®¤ğŸ“Œ"){
              toast("é»˜è®¤åˆ†ç»„ä¸å»ºè®®åˆ ï½");
              return;
            }
            if(!confirm(`åˆ é™¤åˆ†ç»„ã€Œ${g}ã€ï¼Ÿï¼ˆè®°å½•ä¸ä¼šåˆ é™¤ï¼Œä½†ä¼šå½’å›â€œé»˜è®¤ğŸ“Œâ€ï¼‰`)) return;
            state.records.forEach(r=>{
              if((r.group||"é»˜è®¤ğŸ“Œ")===g) r.group = "é»˜è®¤ğŸ“Œ";
            });
            state.groups = state.groups.filter((_,x)=>x!==i);
            saveData();
            draw();
          };
        });
      }

      $("#g_add").onclick = ()=>{
        const v = ($("#g_new").value||"").trim();
        if(!v){ toast("å…ˆå†™åˆ†ç»„åå­—ï½"); return; }
        if(state.groups.includes(v)){ toast("è¿™ä¸ªåˆ†ç»„å·²ç»æœ‰å•¦ï½"); return; }
        state.groups.push(v);
        saveData();
        $("#g_new").value = "";
        toast("å·²æ·»åŠ âœ…");
        draw();
      };

      $("#g_reset").onclick = ()=>{
        if(!confirm("æ¢å¤é»˜è®¤åˆ†ç»„ï¼Ÿï¼ˆä¸ä¼šåˆ é™¤è®°å½•ï¼‰")) return;
        state.groups = structuredClone(defaultData.groups);
        saveData();
        toast("å·²æ¢å¤é»˜è®¤âœ…");
        draw();
      };

      draw();
    }

    function openSummary(){
      const total = state.records.length;
      const fav = state.records.filter(r=>r.fav).length;
      const snackN = state.records.filter(r=> r.type==="snack").length;
      const moneyN = state.records.filter(r=> r.type==="money").length;
      const studyMin = state.records.filter(r=> r.type==="study" && typeof r.amount==="number").reduce((s,r)=> s+r.amount, 0);

      openModal("âœ¨ å°æ€»ç»“", `
        <div class="hint">è¿™æ˜¯â€œä»Šå¤©çš„ä½ â€â€”â€”è®°å½•è¶Šå¤šï¼Œå¤ç›˜è¶Šçˆ½ã€‚</div>
        <div class="row">
          <div class="kpi"><b>æ€»è®°å½•</b><span>${total}</span></div>
          <div class="kpi"><b>æ”¶è—</b><span>${fav}</span></div>
        </div>
        <div class="row">
          <div class="kpi"><b>é›¶é£Ÿè®°å½•</b><span>${snackN}</span></div>
          <div class="kpi"><b>è®°è´¦è®°å½•</b><span>${moneyN}</span></div>
        </div>
        <div class="row">
          <div class="kpi"><b>å­¦ä¹ æ€»åˆ†é’Ÿ</b><span>${studyMin || 0}</span></div>
          <div class="kpi"><b>é›¶é£Ÿå¹³å‡æ˜Ÿçº§</b><span>${snackAvg()}</span></div>
        </div>
      `);
    }

    $("#exportBtn").onclick = ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      const ts = new Date();
      const pad=n=>String(n).padStart(2,"0");
      const name = `xq-life-backup_${ts.getFullYear()}-${pad(ts.getMonth()+1)}-${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.json`;
      a.href = URL.createObjectURL(blob);
      a.download = name;
      a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1500);
      toast("å¤‡ä»½å·²å¯¼å‡ºâœ…");
    };

    $("#importBtn").onclick = ()=> $("#filePicker").click();

    $("#filePicker").addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(!data || !Array.isArray(data.records)){
          toast("å¤‡ä»½æ ¼å¼ä¸å¯¹ğŸ¥º");
          return;
        }
        state = {
          version: 2,
          theme: data.theme || state.theme || "dark",
          groups: Array.isArray(data.groups) && data.groups.length ? data.groups : structuredClone(defaultData.groups),
          records: data.records || []
        };
        saveData();
        setTheme(state.theme);
        toast("å¯¼å…¥æˆåŠŸâœ…");
      }catch(err){
        toast("å¯¼å…¥å¤±è´¥ğŸ¥º");
      }finally{
        $("#filePicker").value = "";
      }
    });

    $("#wipeBtn").onclick = ()=>{
      if(!confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿæ¸…ç©ºåä¸å¯æ¢å¤ï¼ˆé™¤éä½ æœ‰å¤‡ä»½ï¼‰ã€‚")) return;
      localStorage.removeItem(STORAGE_KEY);
      state = loadData();
      setTheme(state.theme);
      toast("å·²æ¸…ç©º");
    };

    $("#themeBtn").onclick = ()=>{
      setTheme(state.theme==="dark" ? "light" : "dark");
    };

    $("#addBtn").onclick = ()=> openAddModal(currentType);
    $("#todayBtn").onclick = ()=> toast("ä»Šå¤©åŠ æ²¹ğŸ˜‹ï¼ˆè®°ä¸€æ¡å°±èµ¢ä¸€æ¡ï¼‰");
    $("#allBtn").onclick = openAllRecords;
    $("#groupsBtn").onclick = openGroups;
    $("#summaryBtn").onclick = openSummary;

    function init(){
      setTheme(state.theme || "dark");
      tickNow();
      setInterval(tickNow, 30*1000);
      renderAll();
    }
    init();
  </script>
</body>
</html>
